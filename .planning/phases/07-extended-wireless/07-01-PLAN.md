---
phase: 07-extended-wireless
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/unifi_scanner/models/enums.py
  - src/unifi_scanner/analysis/rules/wireless.py
  - src/unifi_scanner/analysis/rules/__init__.py
  - tests/analysis/rules/test_wireless.py
autonomous: true

must_haves:
  truths:
    - "Rules match EVT_WU_Roam and EVT_WG_Roam events for client roaming"
    - "Rules match EVT_WU_RoamRadio and EVT_WG_RoamRadio events for band switching"
    - "Rules match EVT_AP_ChannelChange events for channel changes"
    - "DFS radar detection uses pattern matching on message field"
    - "All wireless findings have WIRELESS category"
  artifacts:
    - path: "src/unifi_scanner/models/enums.py"
      provides: "WIRELESS category enum value"
      contains: "WIRELESS = \"wireless\""
    - path: "src/unifi_scanner/analysis/rules/wireless.py"
      provides: "WIRELESS_RULES list with 4 rules"
      exports: ["WIRELESS_RULES"]
    - path: "src/unifi_scanner/analysis/rules/__init__.py"
      provides: "WIRELESS_RULES imported and added to ALL_RULES"
      contains: "WIRELESS_RULES"
    - path: "tests/analysis/rules/test_wireless.py"
      provides: "Unit tests for wireless rules"
      min_lines: 50
  key_links:
    - from: "src/unifi_scanner/analysis/rules/wireless.py"
      to: "src/unifi_scanner/models/enums.py"
      via: "imports Category.WIRELESS"
      pattern: "Category\\.WIRELESS"
    - from: "src/unifi_scanner/analysis/rules/__init__.py"
      to: "src/unifi_scanner/analysis/rules/wireless.py"
      via: "imports WIRELESS_RULES"
      pattern: "from.*wireless import WIRELESS_RULES"
---

<objective>
Create wireless analysis rules for client roaming, band switching, channel changes, and DFS radar detection (WIFI-01 through WIFI-04).

Purpose: Enable the analysis engine to identify and explain wireless events in plain English, helping users understand client mobility and AP channel behavior.

Output: New WIRELESS category, wireless.py with 4 rules, updated rules __init__.py, and unit tests.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-extended-wireless/07-RESEARCH.md

# Existing patterns to follow
@src/unifi_scanner/models/enums.py
@src/unifi_scanner/analysis/rules/base.py
@src/unifi_scanner/analysis/rules/connectivity.py
@src/unifi_scanner/analysis/rules/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WIRELESS category and create wireless rules file</name>
  <files>
    src/unifi_scanner/models/enums.py
    src/unifi_scanner/analysis/rules/wireless.py
  </files>
  <action>
1. Add WIRELESS to Category enum in enums.py:
   - Add after SYSTEM: `WIRELESS = "wireless"`
   - Keep alphabetical order within enum (CONNECTIVITY, PERFORMANCE, SECURITY, SYSTEM, UNCATEGORIZED, WIRELESS)

2. Create wireless.py with WIRELESS_RULES list containing 4 rules:

**Rule 1: client_roaming (WIFI-01)**
- name: "client_roaming"
- event_types: ["EVT_WU_Roam", "EVT_WG_Roam"]
- category: Category.WIRELESS
- severity: Severity.LOW
- title_template: "[Wireless] Client roamed to {device_name}"
- description_template: Explain roaming is normal mobility behavior, mention WU=user/WG=guest
- remediation_template: None (LOW severity)

**Rule 2: band_switch (WIFI-02)**
- name: "band_switch"
- event_types: ["EVT_WU_RoamRadio", "EVT_WG_RoamRadio"]
- category: Category.WIRELESS
- severity: Severity.LOW
- title_template: "[Wireless] Client switched radio bands"
- description_template: Explain band steering, 2.4GHz vs 5GHz switching
- remediation_template: None (LOW severity)

**Rule 3: ap_channel_change (WIFI-03)**
- name: "ap_channel_change"
- event_types: ["EVT_AP_ChannelChange"]
- category: Category.WIRELESS
- severity: Severity.MEDIUM
- title_template: "[Wireless] AP {device_name} changed channel"
- description_template: Explain channel changes for interference avoidance
- remediation_template: Steps for checking WiFi AI, interference sources, manual assignment

**Rule 4: dfs_radar_detected (WIFI-04)**
- name: "dfs_radar_detected"
- event_types: ["EVT_AP_RADAR_DETECTED", "EVT_AP_Interference", "EVT_AP_ChannelChange"]
- category: Category.WIRELESS
- severity: Severity.MEDIUM
- title_template: "[Wireless] DFS radar detected on {device_name}"
- description_template: Explain FCC DFS requirements, 30-minute channel vacation
- remediation_template: Steps for non-DFS channels (36-48), checking radar sources
- pattern: r"[Rr]adar.*(detected|hit)"

Note: DFS rule uses pattern matching because EVT_AP_Interference can mean multiple things - only radar-specific messages should trigger this rule.

File structure matches connectivity.py pattern exactly.
  </action>
  <verify>
    - `python -c "from unifi_scanner.models.enums import Category; print(Category.WIRELESS.value)"` outputs "wireless"
    - `python -c "from unifi_scanner.analysis.rules.wireless import WIRELESS_RULES; print(len(WIRELESS_RULES))"` outputs 4
  </verify>
  <done>
    - WIRELESS category exists in enums.py
    - wireless.py exports WIRELESS_RULES with 4 rules
    - Rules use correct event_types from research
    - DFS rule has pattern field for radar message matching
  </done>
</task>

<task type="auto">
  <name>Task 2: Register wireless rules and add unit tests</name>
  <files>
    src/unifi_scanner/analysis/rules/__init__.py
    tests/analysis/rules/test_wireless.py
  </files>
  <action>
1. Update __init__.py:
   - Import WIRELESS_RULES from wireless.py
   - Add WIRELESS_RULES to ALL_RULES aggregation
   - Add WIRELESS_RULES to __all__ exports

2. Create test_wireless.py with tests:

**Test imports and structure:**
- test_wireless_rules_exist(): Verify WIRELESS_RULES has 4 rules
- test_all_rules_have_wireless_category(): All rules use Category.WIRELESS

**Test rule matching:**
- test_client_roaming_matches_evt_wu_roam(): Rule matches EVT_WU_Roam
- test_client_roaming_matches_evt_wg_roam(): Rule matches EVT_WG_Roam (guest)
- test_band_switch_matches_evt_wu_roamradio(): Rule matches EVT_WU_RoamRadio
- test_band_switch_matches_evt_wg_roamradio(): Rule matches EVT_WG_RoamRadio
- test_channel_change_matches_evt_ap_channelchange(): Rule matches EVT_AP_ChannelChange
- test_dfs_radar_requires_pattern_match(): Rule matches EVT_AP_Interference ONLY with "radar detected" in message
- test_dfs_radar_ignores_non_radar_interference(): Rule does NOT match EVT_AP_Interference without radar message

**Test integration with registry:**
- test_wireless_rules_registered_in_default_registry(): get_default_registry() includes wireless rules

Follow existing test patterns from tests/analysis/rules/test_security.py or test_connectivity.py.
  </action>
  <verify>
    - `python -c "from unifi_scanner.analysis.rules import ALL_RULES, WIRELESS_RULES; print(f'WIRELESS_RULES in ALL_RULES: {all(r in ALL_RULES for r in WIRELESS_RULES)}')"` outputs True
    - `cd /Users/trekkie/projects/unifi_scanner && python -m pytest tests/analysis/rules/test_wireless.py -v` passes all tests
  </verify>
  <done>
    - WIRELESS_RULES integrated into ALL_RULES
    - get_default_registry() includes wireless rules
    - All unit tests pass
    - DFS pattern matching verified to require "radar" in message
  </done>
</task>

</tasks>

<verification>
1. Category enum check:
   ```bash
   python -c "from unifi_scanner.models.enums import Category; print([c.value for c in Category])"
   ```
   Should include "wireless"

2. Rules integration check:
   ```bash
   python -c "from unifi_scanner.analysis.rules import get_default_registry; r = get_default_registry(); print(f'Wireless event types: {[et for et in r.known_event_types if \"Roam\" in et or \"RADAR\" in et or \"Channel\" in et]}')"
   ```
   Should show EVT_WU_Roam, EVT_WG_Roam, EVT_WU_RoamRadio, EVT_WG_RoamRadio, EVT_AP_ChannelChange, EVT_AP_RADAR_DETECTED

3. Full test suite:
   ```bash
   cd /Users/trekkie/projects/unifi_scanner && python -m pytest tests/analysis/rules/ -v
   ```
   All tests pass including new wireless tests
</verification>

<success_criteria>
- WIRELESS category added to enums.py
- wireless.py contains 4 rules matching WIFI-01 through WIFI-04
- Rules follow existing pattern (name, event_types, category, severity, templates)
- DFS radar rule uses pattern field for message matching
- WIRELESS_RULES registered in default registry
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-extended-wireless/07-01-SUMMARY.md`
</output>

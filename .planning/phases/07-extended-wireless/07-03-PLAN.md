---
phase: 07-extended-wireless
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/unifi_scanner/analysis/rules/wireless.py
  - tests/test_wireless_rules.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Roaming rule output shows both source and destination AP names"
    - "Band switch rule output shows actual band transition (2.4GHz to 5GHz)"
    - "Channel change rule output shows channel numbers"
    - "Roaming rule output includes RSSI quality label and dBm value"
  artifacts:
    - path: "src/unifi_scanner/analysis/rules/wireless.py"
      provides: "Updated wireless rule templates"
      contains: "ap_from_name"
    - path: "tests/test_wireless_rules.py"
      provides: "Tests verifying template output"
      contains: "ap_from_name"
  key_links:
    - from: "wireless.py templates"
      to: "engine.py template context"
      via: "template variable substitution"
      pattern: "radio_from_display|radio_to_display|rssi_quality|ap_from_name|ap_to_name|channel_from|channel_to"
---

<objective>
Update wireless rule templates to use existing context variables for user-visible output.

Purpose: Phase 7 built infrastructure (helpers, template context) but rule templates don't USE the context variables. Users see generic output like "Client roamed to AP-Office" instead of "Client roamed from AP-Lobby to AP-Office with Good signal (-58 dBm)".

Output: Updated template strings in wireless.py that produce informative user output using the context variables already available from engine.py.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-extended-wireless/07-VERIFICATION.md
@.planning/phases/07-extended-wireless/07-02-SUMMARY.md

# Source files
@src/unifi_scanner/analysis/rules/wireless.py
@src/unifi_scanner/analysis/engine.py (lines 199-227 for template context)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update wireless rule templates to use context variables</name>
  <files>src/unifi_scanner/analysis/rules/wireless.py</files>
  <action>
    Update the 4 wireless rule templates to use the context variables built in 07-02:

    1. **client_roaming** (line 75):
       - CURRENT: `title_template="[Wireless] Client roamed to {device_name}"`
       - UPDATE TO: `title_template="[Wireless] Client roamed from {ap_from_name} to {ap_to_name}"`
       - Also update description to add signal quality: append " Signal: {rssi_quality} ({rssi} dBm)." after "network connection."

    2. **band_switch** (line 91):
       - CURRENT: `title_template="[Wireless] Client switched radio bands"`
       - UPDATE TO: `title_template="[Wireless] Client switched from {radio_from_display} to {radio_to_display} on {device_name}"`
       - Description already mentions bands generically, which provides educational context - no change needed

    3. **ap_channel_change** (line 107):
       - CURRENT: `title_template="[Wireless] AP {device_name} changed channel"`
       - UPDATE TO: `title_template="[Wireless] AP {device_name} changed channel from {channel_from} to {channel_to}"`
       - No description change needed - existing text explains why channel changes happen

    4. **dfs_radar_detected** - No changes needed (already verified working)

    NOTE: The template context variables {ap_from_name}, {ap_to_name}, {radio_from_display}, {radio_to_display}, {channel_from}, {channel_to}, {rssi_quality}, and {rssi} are already provided by engine.py _build_template_context() method (07-02-SUMMARY confirms this).
  </action>
  <verify>
    Run: `grep -n "ap_from_name\|radio_from_display\|channel_from\|rssi_quality" src/unifi_scanner/analysis/rules/wireless.py`
    Expected: Shows template strings using these variables
  </verify>
  <done>
    - client_roaming title shows "{ap_from_name} to {ap_to_name}"
    - client_roaming description includes "{rssi_quality} ({rssi} dBm)"
    - band_switch title shows "{radio_from_display} to {radio_to_display}"
    - ap_channel_change title shows "from {channel_from} to {channel_to}"
  </done>
</task>

<task type="auto">
  <name>Task 2: Add template output tests to verify variable substitution</name>
  <files>tests/test_wireless_rules.py</files>
  <action>
    Add a new test class `TestWirelessTemplateOutput` to verify the updated templates produce expected output:

    ```python
    class TestWirelessTemplateOutput:
        """Verify templates use context variables correctly."""

        def test_roaming_title_includes_source_and_destination_ap(self):
            """WIFI-01: Roaming title should show both APs."""
            rule = WIRELESS_RULES[0]  # client_roaming
            assert "{ap_from_name}" in rule.title_template
            assert "{ap_to_name}" in rule.title_template

        def test_roaming_description_includes_rssi_quality(self):
            """WIFI-05: Roaming description should show signal quality."""
            rule = WIRELESS_RULES[0]  # client_roaming
            assert "{rssi_quality}" in rule.description_template
            assert "{rssi}" in rule.description_template

        def test_band_switch_title_includes_radio_bands(self):
            """WIFI-02: Band switch title should show actual bands."""
            rule = WIRELESS_RULES[1]  # band_switch
            assert "{radio_from_display}" in rule.title_template
            assert "{radio_to_display}" in rule.title_template

        def test_channel_change_title_includes_channels(self):
            """WIFI-03: Channel change title should show channel numbers."""
            rule = WIRELESS_RULES[2]  # ap_channel_change
            assert "{channel_from}" in rule.title_template
            assert "{channel_to}" in rule.title_template
    ```

    Place this test class after the existing TestFlappingDetection class.
  </action>
  <verify>
    Run: `python -m pytest tests/test_wireless_rules.py::TestWirelessTemplateOutput -v`
    Expected: All 4 tests pass
  </verify>
  <done>
    - TestWirelessTemplateOutput class exists with 4 tests
    - Tests verify presence of context variables in templates
    - All tests pass
  </done>
</task>

</tasks>

<verification>
1. Template variable check:
   ```bash
   grep -E "ap_from_name|ap_to_name|radio_from_display|radio_to_display|channel_from|channel_to|rssi_quality" src/unifi_scanner/analysis/rules/wireless.py
   ```
   Should show at least 7 matches (these variables used in templates)

2. All wireless tests pass:
   ```bash
   python -m pytest tests/test_wireless_rules.py -v
   ```
   Expected: All tests pass including new TestWirelessTemplateOutput

3. Full test suite:
   ```bash
   python -m pytest tests/ -v --tb=short
   ```
   Expected: No regressions introduced
</verification>

<success_criteria>
- [ ] client_roaming title template includes {ap_from_name} and {ap_to_name}
- [ ] client_roaming description template includes {rssi_quality} and {rssi}
- [ ] band_switch title template includes {radio_from_display} and {radio_to_display}
- [ ] ap_channel_change title template includes {channel_from} and {channel_to}
- [ ] New test class TestWirelessTemplateOutput verifies all template variables
- [ ] All tests pass (pytest tests/test_wireless_rules.py)
- [ ] No test regressions (pytest tests/)
</success_criteria>

<output>
After completion, create `.planning/phases/07-extended-wireless/07-03-SUMMARY.md`
</output>

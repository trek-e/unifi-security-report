---
phase: 11-cloudflare-integration
plan: 03
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - src/unifi_scanner/reports/templates/cloudflare_section.html
  - src/unifi_scanner/reports/templates/report.html
autonomous: true

must_haves:
  truths:
    - "Cloudflare section renders WAF events grouped by source"
    - "Cloudflare section shows top blocked IPs"
    - "Cloudflare section shows DNS analytics when available"
    - "Cloudflare section shows tunnel status when tunnels exist"
    - "Cloudflare section is skipped entirely when no data"
  artifacts:
    - path: "src/unifi_scanner/reports/templates/cloudflare_section.html"
      provides: "Cloudflare report section template"
      min_lines: 80
    - path: "src/unifi_scanner/reports/templates/report.html"
      provides: "Include of cloudflare_section.html"
      contains: "cloudflare_section"
  key_links:
    - from: "src/unifi_scanner/reports/templates/report.html"
      to: "cloudflare_section.html"
      via: "Jinja2 include"
      pattern: "include.*cloudflare_section"
---

<objective>
Create Cloudflare report section template and wire into main report.

Purpose: Displays Cloudflare WAF events, DNS analytics, and tunnel status in the security report. Follows existing template patterns (threat_section.html, health_section.html).

Output: Cloudflare section appears in reports when data is available, with consistent styling.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-cloudflare-integration/11-CONTEXT.md
@.planning/phases/11-cloudflare-integration/11-01-SUMMARY.md
@src/unifi_scanner/reports/templates/threat_section.html
@src/unifi_scanner/reports/templates/health_section.html
@src/unifi_scanner/reports/templates/report.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloudflare section template</name>
  <files>
    src/unifi_scanner/reports/templates/cloudflare_section.html
  </files>
  <action>
Create `cloudflare_section.html` following the pattern of existing section templates:

```html
{#
    Cloudflare Security Section Template (HTML)

    Renders Cloudflare WAF events, DNS analytics, and tunnel status.
    This template is meant to be included in the main report template.

    Expected context variable: cloudflare (dict from CloudflareIntegration.fetch() or None)

    Structure per CONTEXT.md:
    1. WAF Events (grouped by source, with top blocked IPs)
    2. DNS Analytics (if Gateway available)
    3. Tunnel Status (if tunnels exist, skip if none)
#}

{% if cloudflare and (cloudflare.has_waf_events or cloudflare.has_dns_analytics or cloudflare.has_tunnels) %}
<!-- Cloudflare Security -->
<div style="margin-top: 30px;">
    <h2 style="color: #333333; font-size: 20px; font-weight: 600; margin: 0 0 15px 0; border-bottom: 2px solid #f38020; padding-bottom: 8px;">
        <span style="color: #f38020;">&#9741;</span> Cloudflare Security
    </h2>

    {# WAF Events Section #}
    {% if cloudflare.has_waf_events %}
    <div style="margin-bottom: 25px;">
        <h3 style="color: #dc3545; font-size: 16px; font-weight: 600; margin: 0 0 12px 0;">
            WAF Blocks
            <span style="font-weight: normal; font-size: 13px; color: #6c757d;">({{ cloudflare.waf_count }} event{% if cloudflare.waf_count != 1 %}s{% endif %})</span>
        </h3>

        {# Group by source (waf, firewallrules, etc.) #}
        {% for source, events in cloudflare.waf_by_source.items() %}
        <div style="margin-bottom: 15px; padding: 12px 15px; background-color: #ffffff; border-left: 4px solid #dc3545; border-radius: 0 4px 4px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
            <div style="margin-bottom: 6px;">
                <span style="display: inline-block; padding: 2px 8px; font-size: 11px; font-weight: 600; text-transform: uppercase; color: #ffffff; background-color: #dc3545; border-radius: 3px;">{{ source | upper }}</span>
                <strong style="color: #333333; font-size: 14px; margin-left: 8px;">{{ events | length }} block{% if events | length != 1 %}s{% endif %}</strong>
            </div>
            {# Show sample events (first 3 per source) #}
            <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #555555; font-size: 13px;">
                {% for event in events[:3] %}
                <li style="margin-bottom: 4px;">
                    <code style="background-color: #f8f9fa; padding: 1px 4px; border-radius: 2px; font-size: 12px;">{{ event.source_ip }}</code>
                    {% if event.country %}({{ event.country }}){% endif %}
                    &rarr; {{ event.host }}{{ event.path[:50] }}{% if event.path | length > 50 %}...{% endif %}
                </li>
                {% endfor %}
                {% if events | length > 3 %}
                <li style="color: #6c757d; font-style: italic;">and {{ events | length - 3 }} more...</li>
                {% endif %}
            </ul>
        </div>
        {% endfor %}

        {# Top Blocked IPs #}
        {% if cloudflare.top_blocked_ips %}
        <div style="margin-top: 15px;">
            <h4 style="color: #495057; font-size: 14px; font-weight: 600; margin: 0 0 8px 0;">
                Top Blocked IPs
            </h4>
            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="font-size: 13px;">
                {% for ip, count in cloudflare.top_blocked_ips[:5] %}
                <tr>
                    <td style="padding: 6px 0; border-bottom: 1px solid #e9ecef; width: 40%;">
                        <code style="background-color: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 12px;">{{ ip }}</code>
                    </td>
                    <td style="padding: 6px 0; border-bottom: 1px solid #e9ecef; color: #333333;">
                        {{ count }} block{% if count != 1 %}s{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# DNS Analytics Section (only if Gateway available) #}
    {% if cloudflare.has_dns_analytics and cloudflare.dns_analytics %}
    <div style="margin-bottom: 25px;">
        <h3 style="color: #17a2b8; font-size: 16px; font-weight: 600; margin: 0 0 12px 0;">
            DNS Analytics <span style="font-weight: normal; font-size: 12px; color: #6c757d;">(Gateway)</span>
        </h3>

        {# Summary Stats #}
        <div style="background-color: #f8f9fa; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                <tr>
                    <td style="text-align: center; padding: 0 10px;">
                        <div style="font-size: 24px; font-weight: 600; color: #333333;">{{ cloudflare.dns_analytics.total_queries }}</div>
                        <div style="font-size: 12px; color: #6c757d; text-transform: uppercase;">Total Queries</div>
                    </td>
                    <td style="text-align: center; padding: 0 10px;">
                        <div style="font-size: 24px; font-weight: 600; color: #dc3545;">{{ cloudflare.dns_analytics.blocked_queries }}</div>
                        <div style="font-size: 12px; color: #6c757d; text-transform: uppercase;">Blocked</div>
                    </td>
                    <td style="text-align: center; padding: 0 10px;">
                        <div style="font-size: 24px; font-weight: 600; color: #28a745;">{{ cloudflare.dns_analytics.allowed_queries }}</div>
                        <div style="font-size: 12px; color: #6c757d; text-transform: uppercase;">Allowed</div>
                    </td>
                </tr>
            </table>
        </div>

        {# Top Blocked Domains #}
        {% if cloudflare.dns_analytics.top_blocked_domains %}
        <div style="margin-top: 10px;">
            <h4 style="color: #495057; font-size: 14px; font-weight: 600; margin: 0 0 8px 0;">
                Top Blocked Domains
            </h4>
            <ul style="margin: 0; padding-left: 20px; color: #555555; font-size: 13px;">
                {% for domain in cloudflare.dns_analytics.top_blocked_domains[:5] %}
                <li style="margin-bottom: 4px;">
                    <code style="background-color: #f8f9fa; padding: 1px 4px; border-radius: 2px; font-size: 12px;">{{ domain }}</code>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# Tunnel Status Section (only if tunnels exist per CONTEXT.md) #}
    {% if cloudflare.has_tunnels %}
    <div style="margin-bottom: 20px;">
        <h3 style="color: #333333; font-size: 16px; font-weight: 600; margin: 0 0 12px 0;">
            Tunnel Status
        </h3>

        {# Down/Degraded Tunnels Warning #}
        {% if cloudflare.has_down_tunnels %}
        <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 12px 16px; margin-bottom: 15px; border-radius: 0 4px 4px 0;">
            <p style="margin: 0; color: #856404; font-size: 14px;">
                <strong style="font-size: 13px;">&#9888; Tunnel Issues</strong><br>
                {% for tunnel in cloudflare.down_tunnels %}
                <span style="display: inline-block; margin-top: 4px;">
                    <code style="background-color: #ffffff; padding: 2px 6px; border-radius: 3px; font-size: 12px;">{{ tunnel.name }}</code>
                    <span style="display: inline-block; padding: 2px 6px; font-size: 11px; font-weight: 600; color: #ffffff; background-color: {% if tunnel.status == 'down' %}#dc3545{% else %}#fd7e14{% endif %}; border-radius: 3px;">{{ tunnel.status | upper }}</span>
                </span>
                {% endfor %}
            </p>
        </div>
        {% endif %}

        {# Tunnel Status Table #}
        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="font-size: 13px; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="padding: 10px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Tunnel</th>
                    <th style="padding: 10px 8px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for tunnel in cloudflare.tunnels %}
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #e9ecef; color: #333333;">{{ tunnel.name }}</td>
                    <td style="padding: 8px; text-align: center; border-bottom: 1px solid #e9ecef;">
                        {% if tunnel.status == 'healthy' %}
                        <span style="display: inline-block; padding: 2px 8px; font-size: 11px; font-weight: 600; color: #155724; background-color: #d4edda; border-radius: 3px;">HEALTHY</span>
                        {% elif tunnel.status == 'degraded' %}
                        <span style="display: inline-block; padding: 2px 8px; font-size: 11px; font-weight: 600; color: #ffffff; background-color: #fd7e14; border-radius: 3px;">DEGRADED</span>
                        {% elif tunnel.status == 'down' %}
                        <span style="display: inline-block; padding: 2px 8px; font-size: 11px; font-weight: 600; color: #ffffff; background-color: #dc3545; border-radius: 3px;">DOWN</span>
                        {% else %}
                        <span style="display: inline-block; padding: 2px 8px; font-size: 11px; font-weight: 600; color: #6c757d; background-color: #e9ecef; border-radius: 3px;">{{ tunnel.status | upper }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {# Zones queried footer #}
    {% if cloudflare.zones_queried %}
    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #e9ecef;">
        <p style="margin: 0; color: #6c757d; font-size: 12px;">
            <strong>Zones:</strong> {{ cloudflare.zones_queried | join(', ') }}
        </p>
    </div>
    {% endif %}
</div>
{% endif %}
```
  </action>
  <verify>
```bash
cd /Users/trekkie/projects/unifi_scanner && python -c "
from jinja2 import Environment, FileSystemLoader
import os

template_dir = 'src/unifi_scanner/reports/templates'
env = Environment(loader=FileSystemLoader(template_dir))
template = env.get_template('cloudflare_section.html')

# Test with sample data
cloudflare_data = {
    'has_waf_events': True,
    'waf_count': 5,
    'waf_by_source': {
        'waf': [
            {'source_ip': '1.2.3.4', 'country': 'CN', 'host': 'example.com', 'path': '/admin'},
            {'source_ip': '5.6.7.8', 'country': 'RU', 'host': 'example.com', 'path': '/wp-admin'},
        ],
    },
    'top_blocked_ips': [('1.2.3.4', 3), ('5.6.7.8', 2)],
    'has_dns_analytics': True,
    'dns_analytics': {
        'total_queries': 1000,
        'blocked_queries': 50,
        'allowed_queries': 950,
        'top_blocked_domains': ['malware.com', 'ads.example.com'],
    },
    'has_tunnels': True,
    'tunnels': [
        {'name': 'prod-tunnel', 'status': 'healthy'},
        {'name': 'dev-tunnel', 'status': 'down'},
    ],
    'has_down_tunnels': True,
    'down_tunnels': [{'name': 'dev-tunnel', 'status': 'down'}],
    'zones_queried': ['example.com', 'test.com'],
}

html = template.render(cloudflare=cloudflare_data)
print(f'Rendered template length: {len(html)} chars')
assert 'Cloudflare Security' in html
assert 'WAF Blocks' in html
assert 'DNS Analytics' in html
assert 'Tunnel Status' in html
print('Template renders correctly!')
"
```
  </verify>
  <done>
Cloudflare section template renders WAF events, DNS analytics, and tunnel status correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire template into main report</name>
  <files>
    src/unifi_scanner/reports/templates/report.html
  </files>
  <action>
Read the current report.html and add include for cloudflare_section.html.

Add after the health_section include (or after threat_section if health_section doesn't exist):

```html
{# Cloudflare Security Section (optional integration) #}
{% if integrations and integrations.has_data %}
    {% set cf_section = integrations.get_section('cloudflare') %}
    {% if cf_section and cf_section.success %}
        {% with cloudflare=cf_section.data %}
            {% include "cloudflare_section.html" %}
        {% endwith %}
    {% elif cf_section and not cf_section.success %}
    <!-- Cloudflare integration error -->
    <div style="margin-top: 30px; padding: 15px; background-color: #fff3cd; border-left: 4px solid #ffc107; border-radius: 0 4px 4px 0;">
        <p style="margin: 0; color: #856404; font-size: 14px;">
            <strong>&#9888; Cloudflare Data Unavailable</strong><br>
            {{ cf_section.error_message }}
        </p>
    </div>
    {% endif %}
{% endif %}
```

This wires the integration result from IntegrationRunner into the template.
  </action>
  <verify>
```bash
cd /Users/trekkie/projects/unifi_scanner && python -c "
from jinja2 import Environment, FileSystemLoader

template_dir = 'src/unifi_scanner/reports/templates'
env = Environment(loader=FileSystemLoader(template_dir))
template = env.get_template('report.html')

# Check that cloudflare_section is referenced
source = open(f'{template_dir}/report.html').read()
assert 'cloudflare_section' in source, 'Should include cloudflare_section'
print('report.html includes cloudflare_section!')
"
```
  </verify>
  <done>
report.html includes cloudflare_section.html template. Integration data wired correctly.
  </done>
</task>

</tasks>

<verification>
1. cloudflare_section.html exists and renders sample data
2. report.html includes cloudflare_section.html
3. Template handles missing cloudflare data gracefully (skips section)
4. Template handles error state (shows error message)
</verification>

<success_criteria>
- cloudflare_section.html template exists with WAF, DNS, and tunnel sections
- report.html includes cloudflare_section conditionally
- Template renders correctly with sample Cloudflare data
- Template gracefully handles missing data
</success_criteria>

<output>
After completion, create `.planning/phases/11-cloudflare-integration/11-03-SUMMARY.md`
</output>

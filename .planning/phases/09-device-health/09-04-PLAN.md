---
phase: 09-device-health
plan: 04
type: execute
wave: 3
depends_on: ["09-01", "09-02", "09-03"]
files_modified:
  - src/unifi_scanner/reports/templates/health_section.html
  - src/unifi_scanner/reports/templates/health_section.txt
  - src/unifi_scanner/reports/templates/report.html
  - src/unifi_scanner/reports/templates/report.txt
  - src/unifi_scanner/reports/generator.py
  - src/unifi_scanner/__main__.py
  - tests/test_device_health_integration.py
autonomous: true

must_haves:
  truths:
    - "Report shows device health summary section when health data exists"
    - "Critical findings appear prominently with red styling in HTML"
    - "Device table shows CPU, memory, temperature, uptime for all devices"
    - "Health analysis failures are non-fatal and logged as warnings"
  artifacts:
    - path: "src/unifi_scanner/reports/templates/health_section.html"
      provides: "HTML template for device health section"
      min_lines: 80
    - path: "src/unifi_scanner/reports/templates/health_section.txt"
      provides: "Text template for device health section"
      min_lines: 30
    - path: "tests/test_device_health_integration.py"
      provides: "End-to-end integration tests"
      min_lines: 60
  key_links:
    - from: "__main__.run_report_job"
      to: "client.get_devices"
      via: "device stats collection"
      pattern: "get_devices"
    - from: "__main__.run_report_job"
      to: "DeviceHealthAnalyzer.analyze_devices"
      via: "health analysis"
      pattern: "DeviceHealthAnalyzer"
    - from: "generator._build_context"
      to: "health_analysis"
      via: "context variable"
      pattern: "health_analysis"
    - from: "report.html"
      to: "health_section.html"
      via: "template include"
      pattern: "include.*health_section"
---

<objective>
Create health report templates and integrate DeviceHealthAnalyzer into the report generation pipeline.

Purpose: Enable users to see device health status in their reports with proactive alerts before failures occur. Following Phase 8's IPS integration pattern.

Output: Health section templates (HTML + text), service integration with optional health analysis, and end-to-end tests.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-device-health/09-RESEARCH.md

# Dependencies from prior plans
@src/unifi_scanner/analysis/device_health/models.py
@src/unifi_scanner/analysis/device_health/analyzer.py
@src/unifi_scanner/api/client.py

# Reference Phase 8 integration pattern
@src/unifi_scanner/reports/templates/threat_section.html
@src/unifi_scanner/reports/generator.py
@src/unifi_scanner/__main__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health section templates</name>
  <files>
    src/unifi_scanner/reports/templates/health_section.html
    src/unifi_scanner/reports/templates/health_section.txt
    src/unifi_scanner/reports/templates/report.html
    src/unifi_scanner/reports/templates/report.txt
  </files>
  <action>
  Create health_section.html following threat_section.html pattern:
  1. Wrap in `{% if health_analysis %}` conditional
  2. Add "Device Health Summary" h2 header with blue border-bottom (#2282FF)
  3. Executive summary box showing: total devices, healthy count (green), warnings (orange), critical (red)
  4. If critical_findings exist: "Critical Issues" section with red styling
     - Each finding: device name, description, current value vs threshold, remediation box
  5. If warning_findings exist: "Warnings" section with orange styling
     - Same finding structure as critical but orange colors
  6. Device status table with columns: Device, CPU, Memory, Temp, Uptime, Status
     - Show "-" for None values
     - Status column: green "OK" if healthy, red issue list if not
  7. Use existing report.html styling patterns (padding, fonts, colors)

  Create health_section.txt with plain text equivalent:
  1. "DEVICE HEALTH SUMMARY" header with === underline
  2. Executive summary line: "X devices: Y healthy, Z with warnings, W critical"
  3. CRITICAL ISSUES section if any critical findings
  4. WARNINGS section if any warning findings
  5. Device table with fixed-width columns

  Update report.html:
  - Add `{% include 'health_section.html' %}` after threat section, before findings sections

  Update report.txt:
  - Add `{% include 'health_section.txt' %}` after threat section
  </action>
  <verify>
  ```bash
  python -c "from jinja2 import Environment, PackageLoader; env = Environment(loader=PackageLoader('unifi_scanner.reports', 'templates')); t = env.get_template('health_section.html'); print('HTML template loads')"
  python -c "from jinja2 import Environment, PackageLoader; env = Environment(loader=PackageLoader('unifi_scanner.reports', 'templates')); t = env.get_template('health_section.txt'); print('Text template loads')"
  ```
  </verify>
  <done>Health section templates created and included in main report templates</done>
</task>

<task type="auto">
  <name>Task 2: Update ReportGenerator and service integration</name>
  <files>
    src/unifi_scanner/reports/generator.py
    src/unifi_scanner/__main__.py
  </files>
  <action>
  Update generator.py:
  1. Add import: `from unifi_scanner.analysis.device_health import DeviceHealthResult`
  2. Update _build_context signature to accept `health_analysis: Optional[DeviceHealthResult] = None`
  3. Add `"health_analysis": health_analysis` to returned context dict
  4. Update generate_html signature to accept health_analysis parameter, pass to _build_context
  5. Update generate_text signature to accept health_analysis parameter, pass to _build_context

  Update __main__.py run_report_job():
  1. Add imports at function top:
     ```python
     from unifi_scanner.analysis.device_health import DeviceHealthAnalyzer, DeviceStats
     ```
  2. After IPS analysis block, add device health analysis block:
     ```python
     # Collect and analyze device health
     health_analysis = None
     try:
         raw_devices = client.get_devices(site=site)
         if raw_devices:
             device_stats = [DeviceStats.from_api_response(d) for d in raw_devices]
             health_analyzer = DeviceHealthAnalyzer()
             health_analysis = health_analyzer.analyze_devices(device_stats)
             log.info(
                 "health_analysis_complete",
                 device_count=len(device_stats),
                 critical=len(health_analysis.critical_findings),
                 warnings=len(health_analysis.warning_findings),
             )
         else:
             log.debug("no_devices_found", site=site)
     except Exception as e:
         # Health analysis is optional - don't fail the whole report
         log.warning("health_analysis_failed", error=str(e))
     ```
  3. Update generator.generate_html call to pass health_analysis:
     `html_content = generator.generate_html(report, ips_analysis=ips_analysis, health_analysis=health_analysis)`
  4. Update generator.generate_text call similarly
  </action>
  <verify>
  ```bash
  python -c "from unifi_scanner.reports.generator import ReportGenerator; r = ReportGenerator(); print('health_analysis' in str(r.generate_html.__code__.co_varnames))"
  python -c "import ast; tree = ast.parse(open('src/unifi_scanner/__main__.py').read()); funcs = [n.name for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]; print('run_report_job' in funcs)"
  ```
  </verify>
  <done>ReportGenerator accepts health_analysis parameter, run_report_job fetches and analyzes device health</done>
</task>

<task type="auto">
  <name>Task 3: Create integration tests</name>
  <files>
    tests/test_device_health_integration.py
  </files>
  <action>
  Create tests/test_device_health_integration.py with comprehensive tests:

  1. Test template rendering with health_analysis:
     - Create mock DeviceHealthResult with critical and warning findings
     - Call generator.generate_html with health_analysis
     - Assert "Device Health Summary" appears in output
     - Assert critical findings appear with CRITICAL badge
     - Assert device table appears with device names

  2. Test template rendering without health_analysis:
     - Call generator.generate_html with health_analysis=None
     - Assert health section does NOT appear (no "Device Health Summary")

  3. Test empty health result:
     - Create DeviceHealthResult with no findings but with device summaries
     - Assert section appears but no critical/warning subsections
     - Assert device table shows all healthy devices

  4. Test text template rendering:
     - Create DeviceHealthResult with findings
     - Call generator.generate_text
     - Assert "DEVICE HEALTH SUMMARY" appears
     - Assert device information is formatted correctly

  5. Test full pipeline mock:
     - Mock client.get_devices to return sample device data
     - Verify DeviceStats.from_api_response processes it
     - Verify DeviceHealthAnalyzer produces expected result
     - Verify result integrates into report context

  Use pytest fixtures for common test data:
  - sample_device_stats: List of DeviceStats with various health states
  - sample_health_result: DeviceHealthResult with mixed findings
  </action>
  <verify>
  ```bash
  python -m pytest tests/test_device_health_integration.py -v
  ```
  </verify>
  <done>Integration tests pass covering template rendering and service integration</done>
</task>

</tasks>

<verification>
```bash
# Run all device health tests
python -m pytest tests/test_device_health*.py -v

# Verify full module works
python -c "
from unifi_scanner.analysis.device_health import DeviceStats, DeviceHealthAnalyzer, DeviceHealthResult
from unifi_scanner.reports.generator import ReportGenerator
print('All imports successful')
"

# Check templates load
python -c "
from jinja2 import Environment, PackageLoader
env = Environment(loader=PackageLoader('unifi_scanner.reports', 'templates'))
for t in ['report.html', 'report.txt', 'health_section.html', 'health_section.txt']:
    env.get_template(t)
print('All templates load')
"
```
</verification>

<success_criteria>
- Health section appears in reports when health_analysis is provided
- Critical findings shown prominently with red styling
- Device table displays all monitored metrics
- Health analysis failures logged as warnings, don't block report
- All integration tests pass
- Templates render without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-device-health/09-04-SUMMARY.md`
</output>

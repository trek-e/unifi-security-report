---
phase: 09-device-health
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/unifi_scanner/analysis/rules/health.py
  - src/unifi_scanner/analysis/rules/__init__.py
  - src/unifi_scanner/api/endpoints.py
  - src/unifi_scanner/api/client.py
  - tests/test_health_rules.py
autonomous: true

must_haves:
  truths:
    - "PoE disconnect events generate MEDIUM severity findings with port identification"
    - "PoE overload events generate SEVERE severity findings requiring immediate attention"
    - "API client can fetch device stats from stat/device endpoint"
    - "Endpoints definition includes devices endpoint for both UDM and self-hosted"
  artifacts:
    - path: "src/unifi_scanner/analysis/rules/health.py"
      provides: "HEALTH_RULES for PoE events"
      min_lines: 40
    - path: "src/unifi_scanner/api/client.py"
      provides: "get_devices method"
      contains: "def get_devices"
  key_links:
    - from: "rules/__init__.py"
      to: "health.py"
      via: "HEALTH_RULES import and aggregation"
      pattern: "HEALTH_RULES"
    - from: "client.get_devices"
      to: "endpoints.devices"
      via: "endpoint format and request"
      pattern: "endpoints\\.devices\\.format"
---

<objective>
Add PoE health event rules and extend API client with get_devices() method for stat/device data collection.

Purpose: Enable detection of PoE disconnect/overload events through rule-based analysis, and provide API access to device metrics (CPU, memory, temperature, uptime) from the stat/device endpoint.

Output: HEALTH_RULES list integrated with existing rules, get_devices() method on UnifiClient, updated endpoints.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-device-health/09-RESEARCH.md

# Reference existing patterns
@src/unifi_scanner/analysis/rules/system.py
@src/unifi_scanner/analysis/rules/__init__.py
@src/unifi_scanner/api/client.py
@src/unifi_scanner/api/endpoints.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HEALTH_RULES for PoE events</name>
  <files>
    src/unifi_scanner/analysis/rules/health.py
    src/unifi_scanner/analysis/rules/__init__.py
    tests/test_health_rules.py
  </files>
  <action>
  Create health.py with HEALTH_RULES list containing:

  1. poe_disconnect rule:
     - event_types: ["EVT_SW_PoeDisconnect"]
     - category: Category.SYSTEM
     - severity: Severity.MEDIUM
     - title_template: "[Device Health] PoE device disconnected on {device_name} port {port}"
     - description_template explains what happened (device lost power)
     - remediation_template with 5 steps: check budget, verify cable, check damage, consider injectors, review device

  2. poe_overload rule:
     - event_types: ["EVT_SW_PoeOverload", "EVT_SW_PoeBudgetExceeded"]
     - category: Category.SYSTEM
     - severity: Severity.SEVERE
     - title_template: "[Device Health] PoE power budget exceeded on {device_name}"
     - description_template emphasizes immediate attention required
     - remediation_template with 6 steps: check devices, disconnect non-critical, review consumption, upgrade switch, use injectors, set port limits

  Update rules/__init__.py:
  - Import HEALTH_RULES from health module
  - Add HEALTH_RULES to ALL_RULES aggregation
  - Add to __all__ exports

  Create tests/test_health_rules.py:
  - Test rules are registered in get_default_registry()
  - Test poe_disconnect event matches rule and generates MEDIUM finding
  - Test poe_overload event matches rule and generates SEVERE finding
  - Test remediation templates are present for both rules
  </action>
  <verify>
  ```bash
  python -m pytest tests/test_health_rules.py -v
  python -c "from unifi_scanner.analysis.rules import HEALTH_RULES, ALL_RULES; print(f'HEALTH_RULES: {len(HEALTH_RULES)}'); assert HEALTH_RULES[0].name == 'poe_disconnect'"
  ```
  </verify>
  <done>HEALTH_RULES list with 2 PoE rules integrated into ALL_RULES, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add get_devices() method and endpoints</name>
  <files>
    src/unifi_scanner/api/endpoints.py
    src/unifi_scanner/api/client.py
  </files>
  <action>
  Update endpoints.py:
  1. Add `devices: str` field to Endpoints dataclass
  2. Set UDM_PRO_ENDPOINTS.devices = "/proxy/network/api/s/{site}/stat/device"
  3. Set SELF_HOSTED_ENDPOINTS.devices = "/api/s/{site}/stat/device"

  Update client.py - add get_devices() method to UnifiClient:
  ```python
  def get_devices(
      self,
      site: str,
      device_type: Optional[str] = None,
  ) -> List[Dict[str, Any]]:
      """Get device statistics from the controller.

      Returns detailed device information including system stats,
      temperatures, PoE status, and port information.

      Args:
          site: Site name to retrieve devices from.
          device_type: Optional filter by type (uap, usw, ugw, udm).

      Returns:
          List of device dictionaries with system-stats, temps, etc.
      """
      self._ensure_connected()
      assert self.device_type is not None

      endpoints = get_endpoints(self.device_type)
      endpoint = endpoints.devices.format(site=site)

      response = self._request("GET", endpoint)
      data = response.json()

      devices = data.get("data", data) if isinstance(data, dict) else data

      # Optional type filter
      if device_type:
          devices = [d for d in devices if d.get("type") == device_type]

      logger.debug("devices_retrieved", count=len(devices), site=site)
      return devices
  ```

  Import Optional at top of client.py if not already imported.
  </action>
  <verify>
  ```bash
  python -c "from unifi_scanner.api.endpoints import UDM_PRO_ENDPOINTS, SELF_HOSTED_ENDPOINTS; print(f'UDM: {UDM_PRO_ENDPOINTS.devices}'); print(f'Self: {SELF_HOSTED_ENDPOINTS.devices}')"
  python -c "from unifi_scanner.api import UnifiClient; print('get_devices' in dir(UnifiClient))"
  ```
  </verify>
  <done>get_devices() method added to UnifiClient, endpoints include devices for both controller types</done>
</task>

</tasks>

<verification>
```bash
# Run all related tests
python -m pytest tests/test_health_rules.py tests/test_api*.py -v --tb=short

# Verify exports
python -c "from unifi_scanner.analysis.rules import HEALTH_RULES, get_default_registry; r = get_default_registry(); print(f'Total rules: {len(r._rules)}')"
```
</verification>

<success_criteria>
- HEALTH_RULES contains 2 rules (poe_disconnect, poe_overload)
- Rules integrated into ALL_RULES and default registry
- get_devices() method exists on UnifiClient
- Endpoints include devices path for UDM and self-hosted
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-device-health/09-02-SUMMARY.md`
</output>

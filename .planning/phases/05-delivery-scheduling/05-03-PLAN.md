---
phase: 05-delivery-scheduling
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/unifi_scanner/config/settings.py
  - src/unifi_scanner/scheduler/__init__.py
  - src/unifi_scanner/scheduler/runner.py
  - src/unifi_scanner/scheduler/presets.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Service runs jobs on configurable schedule (cron or preset)"
    - "Scheduler supports timezone configuration (not locked to UTC)"
    - "Missed runs are handled gracefully with coalesce and grace time"
    - "One-shot mode runs once and exits when no schedule configured"
  artifacts:
    - path: "src/unifi_scanner/scheduler/runner.py"
      provides: "ScheduledRunner class with APScheduler"
      exports: ["ScheduledRunner"]
    - path: "src/unifi_scanner/scheduler/presets.py"
      provides: "Schedule preset definitions"
      exports: ["SCHEDULE_PRESETS", "get_preset"]
    - path: "src/unifi_scanner/config/settings.py"
      provides: "Schedule configuration settings"
      contains: "schedule_preset"
    - path: "pyproject.toml"
      provides: "APScheduler dependency"
      contains: "APScheduler"
  key_links:
    - from: "src/unifi_scanner/scheduler/runner.py"
      to: "apscheduler.schedulers.blocking"
      via: "BlockingScheduler import"
      pattern: "BlockingScheduler"
    - from: "src/unifi_scanner/scheduler/runner.py"
      to: "apscheduler.triggers.cron"
      via: "CronTrigger for cron expressions"
      pattern: "CronTrigger"
---

<objective>
Create APScheduler-based scheduling system with cron expressions and presets.

Purpose: Enable automated report generation on configurable schedules with timezone support.
Output: ScheduledRunner class that manages the service loop with APScheduler.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-delivery-scheduling/05-RESEARCH.md
@.planning/phases/05-delivery-scheduling/05-CONTEXT.md

# Existing files to extend/reference
@src/unifi_scanner/config/settings.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add APScheduler dependency and schedule settings</name>
  <files>pyproject.toml, src/unifi_scanner/config/settings.py</files>
  <action>
In pyproject.toml, add APScheduler to dependencies:
```toml
"APScheduler>=3.10,<4.0",
```

In settings.py, add schedule configuration:

```python
# Schedule settings
schedule_preset: Optional[str] = Field(
    default=None,
    description="Schedule preset: daily_8am, daily_6pm, weekly_monday_8am, weekly_friday_5pm",
)
schedule_cron: Optional[str] = Field(
    default=None,
    description="Custom cron expression (5-field format: min hour day month weekday)",
)
schedule_timezone: str = Field(
    default="UTC",
    description="Timezone for schedule (IANA format, e.g., America/New_York)",
)
```

Note: If neither schedule_preset nor schedule_cron is set, service runs in one-shot mode.
Add validator: schedule_preset must be one of the known presets if set.
  </action>
  <verify>
Run `pip install -e .` succeeds with APScheduler installed.
Run `python -c "from unifi_scanner.config.settings import UnifiSettings; print('imports ok')"` succeeds.
  </verify>
  <done>
APScheduler is a project dependency and schedule settings exist in UnifiSettings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create scheduler module with presets and runner</name>
  <files>src/unifi_scanner/scheduler/__init__.py, src/unifi_scanner/scheduler/presets.py, src/unifi_scanner/scheduler/runner.py</files>
  <action>
Create src/unifi_scanner/scheduler/ directory and files.

In presets.py:
```python
"""Schedule preset definitions."""

from typing import Any, Dict, Optional

# Preset schedules with cron-style parameters
SCHEDULE_PRESETS: Dict[str, Dict[str, Any]] = {
    "daily_8am": {"hour": 8, "minute": 0},
    "daily_6pm": {"hour": 18, "minute": 0},
    "weekly_monday_8am": {"day_of_week": "mon", "hour": 8, "minute": 0},
    "weekly_friday_5pm": {"day_of_week": "fri", "hour": 17, "minute": 0},
}


def get_preset(name: str) -> Optional[Dict[str, Any]]:
    """Get schedule preset by name.

    Args:
        name: Preset name (e.g., 'daily_8am')

    Returns:
        Dict of cron parameters, or None if not found
    """
    return SCHEDULE_PRESETS.get(name)


def list_presets() -> list[str]:
    """List available preset names."""
    return list(SCHEDULE_PRESETS.keys())
```

In runner.py:
```python
"""Scheduled runner using APScheduler."""

from datetime import datetime, timedelta
from typing import Callable, Optional

import structlog
from apscheduler.events import EVENT_JOB_ERROR, EVENT_JOB_EXECUTED
from apscheduler.schedulers.blocking import BlockingScheduler
from apscheduler.triggers.cron import CronTrigger

from unifi_scanner.scheduler.presets import SCHEDULE_PRESETS, get_preset

log = structlog.get_logger()


class SchedulerError(Exception):
    """Raised when scheduler configuration fails."""
    pass


class ScheduledRunner:
    """APScheduler-based service runner.

    Supports:
    - Cron expressions (5-field format)
    - Named presets (daily_8am, weekly_monday_8am, etc.)
    - One-shot mode (no schedule = run once and exit)
    - Configurable timezone
    """

    def __init__(
        self,
        timezone: str = "UTC",
        misfire_grace_time: int = 3600,  # 1 hour
    ) -> None:
        """Initialize scheduler.

        Args:
            timezone: IANA timezone for schedule (e.g., 'America/New_York')
            misfire_grace_time: Seconds after scheduled time to still run missed job
        """
        self.timezone = timezone
        self.misfire_grace_time = misfire_grace_time
        self._scheduler: Optional[BlockingScheduler] = None
        self._job_func: Optional[Callable[[], None]] = None

    def _create_scheduler(self) -> BlockingScheduler:
        """Create configured BlockingScheduler."""
        job_defaults = {
            "coalesce": True,  # Combine missed runs into one
            "misfire_grace_time": self.misfire_grace_time,
            "max_instances": 1,  # Prevent concurrent runs
        }
        return BlockingScheduler(
            timezone=self.timezone,
            job_defaults=job_defaults,
        )

    def _add_cron_job(
        self,
        scheduler: BlockingScheduler,
        func: Callable[[], None],
        cron_expr: str,
    ) -> None:
        """Add job with cron expression (5-field format).

        Args:
            scheduler: The scheduler to add job to
            func: Function to execute on schedule
            cron_expr: Cron expression (min hour day month weekday)
        """
        # IMPORTANT: Always pass timezone explicitly to from_crontab()
        # It does NOT inherit from scheduler timezone
        trigger = CronTrigger.from_crontab(cron_expr, timezone=self.timezone)
        scheduler.add_job(func, trigger, id="report_job")
        log.info(
            "job_scheduled",
            schedule_type="cron",
            cron=cron_expr,
            timezone=self.timezone,
        )

    def _add_preset_job(
        self,
        scheduler: BlockingScheduler,
        func: Callable[[], None],
        preset: str,
    ) -> None:
        """Add job using preset schedule.

        Args:
            scheduler: The scheduler to add job to
            func: Function to execute on schedule
            preset: Preset name (e.g., 'daily_8am')

        Raises:
            SchedulerError: If preset is unknown
        """
        params = get_preset(preset)
        if params is None:
            available = ", ".join(SCHEDULE_PRESETS.keys())
            raise SchedulerError(f"Unknown schedule preset: '{preset}'. Available: {available}")

        scheduler.add_job(
            func,
            "cron",
            timezone=self.timezone,
            **params,
            id="report_job",
        )
        log.info(
            "job_scheduled",
            schedule_type="preset",
            preset=preset,
            params=params,
            timezone=self.timezone,
        )

    def run_once(self, func: Callable[[], None]) -> None:
        """Execute function once immediately, then exit.

        Used when no schedule is configured (one-shot mode).

        Args:
            func: Function to execute
        """
        log.info("one_shot_mode", message="Running once and exiting")
        scheduler = self._create_scheduler()

        # Schedule for 1 second from now
        run_time = datetime.now() + timedelta(seconds=1)
        scheduler.add_job(
            func,
            "date",
            run_date=run_time,
            id="oneshot_job",
        )

        # Shutdown after job completes
        def shutdown_after_job(event: Any) -> None:
            scheduler.shutdown(wait=False)

        scheduler.add_listener(shutdown_after_job, EVENT_JOB_EXECUTED | EVENT_JOB_ERROR)
        scheduler.start()

    def run(
        self,
        func: Callable[[], None],
        cron_expr: Optional[str] = None,
        preset: Optional[str] = None,
    ) -> None:
        """Start the scheduler with the given job.

        If neither cron_expr nor preset is provided, runs in one-shot mode.

        Args:
            func: Function to execute on schedule
            cron_expr: Optional cron expression (5-field)
            preset: Optional preset name

        Raises:
            SchedulerError: If both cron_expr and preset are provided
        """
        if cron_expr and preset:
            raise SchedulerError("Cannot specify both cron expression and preset")

        # One-shot mode if no schedule
        if not cron_expr and not preset:
            self.run_once(func)
            return

        # Create scheduler and add job
        self._scheduler = self._create_scheduler()
        self._job_func = func

        if cron_expr:
            self._add_cron_job(self._scheduler, func, cron_expr)
        else:
            self._add_preset_job(self._scheduler, func, preset)  # type: ignore

        # Add error listener for logging
        def on_job_error(event: Any) -> None:
            log.error("job_failed", error=str(event.exception))

        self._scheduler.add_listener(on_job_error, EVENT_JOB_ERROR)

        # Start blocking scheduler (runs until interrupted)
        log.info("scheduler_starting", timezone=self.timezone)
        try:
            self._scheduler.start()
        except KeyboardInterrupt:
            log.info("scheduler_shutdown", reason="keyboard interrupt")

    def shutdown(self) -> None:
        """Gracefully shutdown the scheduler."""
        if self._scheduler and self._scheduler.running:
            self._scheduler.shutdown(wait=True)
            log.info("scheduler_shutdown", reason="explicit shutdown")
```

In __init__.py:
```python
"""Scheduler subsystem for automated report generation."""

from unifi_scanner.scheduler.presets import SCHEDULE_PRESETS, get_preset, list_presets
from unifi_scanner.scheduler.runner import ScheduledRunner, SchedulerError

__all__ = [
    "ScheduledRunner",
    "SchedulerError",
    "SCHEDULE_PRESETS",
    "get_preset",
    "list_presets",
]
```
  </action>
  <verify>
Run `python -c "from unifi_scanner.scheduler import ScheduledRunner, list_presets; print(list_presets())"` shows preset names.
Run `python -c "from apscheduler.schedulers.blocking import BlockingScheduler; print('apscheduler ok')"` succeeds.
  </verify>
  <done>
ScheduledRunner class exists with cron, preset, and one-shot mode support. APScheduler is installed.
  </done>
</task>

</tasks>

<verification>
- APScheduler 3.x is installed (not 4.x alpha)
- ScheduledRunner supports cron expressions via CronTrigger.from_crontab()
- Timezone is explicitly passed to CronTrigger (not relying on scheduler default)
- Presets defined: daily_8am, daily_6pm, weekly_monday_8am, weekly_friday_5pm
- One-shot mode runs immediately when no schedule configured
- misfire_grace_time set to 3600 (1 hour) with coalesce=True
</verification>

<success_criteria>
1. `from unifi_scanner.scheduler import ScheduledRunner` works
2. `pip show apscheduler` shows version 3.x installed
3. ScheduledRunner.run(func, preset="daily_8am") configures job correctly
4. ScheduledRunner.run(func) (no args) triggers one-shot mode
</success_criteria>

<output>
After completion, create `.planning/phases/05-delivery-scheduling/05-03-SUMMARY.md`
</output>

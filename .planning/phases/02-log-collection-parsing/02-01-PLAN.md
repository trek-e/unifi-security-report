---
phase: 02-log-collection-parsing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/unifi_scanner/api/client.py
  - src/unifi_scanner/api/endpoints.py
  - tests/test_api_client.py
autonomous: true

must_haves:
  truths:
    - "Client can retrieve events from UniFi API with pagination"
    - "Client can retrieve alarms from UniFi API"
    - "API response truncation is detected and logged"
    - "Both UDM and self-hosted endpoint paths are supported"
  artifacts:
    - path: "src/unifi_scanner/api/client.py"
      provides: "get_events() and get_alarms() methods"
      contains: "def get_events"
    - path: "src/unifi_scanner/api/endpoints.py"
      provides: "events and alarms endpoint definitions"
      contains: "events:"
  key_links:
    - from: "src/unifi_scanner/api/client.py"
      to: "endpoints.py"
      via: "get_endpoints() for endpoint paths"
      pattern: "get_endpoints.*events"
---

<objective>
Add event and alarm retrieval methods to UnifiClient for API-based log collection.

Purpose: Enable the scanner to fetch event logs and alarms from UniFi controllers, which is the primary source of log data. The API provides structured JSON with timestamps, event types, and device information.

Output: UnifiClient with get_events() and get_alarms() methods that handle pagination, truncation detection, and proper endpoint routing for both UDM and self-hosted controllers.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-log-collection-parsing/02-RESEARCH.md

# Key existing files
@src/unifi_scanner/api/client.py
@src/unifi_scanner/api/endpoints.py
@src/unifi_scanner/api/exceptions.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add events and alarms endpoints to Endpoints dataclass</name>
  <files>src/unifi_scanner/api/endpoints.py</files>
  <action>
Add events and alarms endpoint paths to the Endpoints dataclass:

1. Add two new fields to Endpoints dataclass:
   - `events: str` - POST endpoint for retrieving events
   - `alarms: str` - GET endpoint for retrieving alarms

2. Update UDM_PRO_ENDPOINTS with:
   - `events="/proxy/network/api/s/{site}/stat/event"`
   - `alarms="/proxy/network/api/s/{site}/list/alarm"`

3. Update SELF_HOSTED_ENDPOINTS with:
   - `events="/api/s/{site}/stat/event"`
   - `alarms="/api/s/{site}/list/alarm"`

Note: The {site} placeholder will be formatted by the client methods.
  </action>
  <verify>
Run: `python -c "from unifi_scanner.api.endpoints import get_endpoints, DeviceType; e = get_endpoints(DeviceType.UDM_PRO); print(e.events, e.alarms)"`
Should print: `/proxy/network/api/s/{site}/stat/event /proxy/network/api/s/{site}/list/alarm`
  </verify>
  <done>
Endpoints dataclass includes events and alarms fields with correct paths for both UDM and self-hosted device types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement get_events and get_alarms methods on UnifiClient</name>
  <files>src/unifi_scanner/api/client.py</files>
  <action>
Add two methods to UnifiClient class:

1. `get_events(self, site: str, history_hours: int = 720, start: int = 0, limit: int = 3000) -> List[Dict[str, Any]]`:
   - Build endpoint URL: `endpoints.events.format(site=site)`
   - POST with JSON body: `{"_sort": "-time", "within": history_hours, "_start": start, "_limit": min(limit, 3000)}`
   - Parse response JSON, extract `data` field
   - Check for truncation: if `meta.count` exists and exceeds len(data), log warning with structlog
   - Return list of event dicts

2. `get_alarms(self, site: str, archived: Optional[bool] = None) -> List[Dict[str, Any]]`:
   - Build endpoint URL: `endpoints.alarms.format(site=site)`
   - GET with optional query param `archived` (as lowercase string if specified)
   - Parse response JSON, extract `data` field
   - Return list of alarm dicts

Both methods should:
- Call `self._ensure_connected()` first
- Use `self._request()` for automatic session handling
- Get endpoints via `get_endpoints(self.device_type)`
- Use structlog for debug logging (count of results retrieved)

Import List from typing (already imported). Import Optional from typing (already imported).
  </action>
  <verify>
Run: `python -c "from unifi_scanner.api.client import UnifiClient; import inspect; print('get_events' in dir(UnifiClient), 'get_alarms' in dir(UnifiClient))"`
Should print: `True True`
  </verify>
  <done>
UnifiClient has get_events() and get_alarms() methods that retrieve data from the correct endpoints with proper pagination and truncation detection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for event and alarm retrieval</name>
  <files>tests/test_api_client.py</files>
  <action>
Create or extend test file with tests for the new methods:

1. Test `test_get_events_returns_data`:
   - Mock httpx.Client to return a response with `{"data": [{"key": "EVT_AP_Connected", "time": 1705084800000}]}`
   - Call client.get_events("default")
   - Assert returns list with one event dict

2. Test `test_get_events_detects_truncation`:
   - Mock response with `{"meta": {"count": 5000}, "data": [...]}`  (data with 3000 items)
   - Call client.get_events("default")
   - Assert warning was logged (use structlog testing utilities or caplog)

3. Test `test_get_alarms_returns_data`:
   - Mock response with alarm data
   - Call client.get_alarms("default")
   - Assert returns list

4. Test `test_get_alarms_filters_archived`:
   - Mock client and verify query param `archived=true` is passed when archived=True
   - Mock client and verify query param `archived=false` is passed when archived=False
   - Mock client and verify no archived param when archived=None

Use pytest and unittest.mock. Follow existing test patterns in the project.
  </action>
  <verify>
Run: `pytest tests/test_api_client.py -v`
All tests should pass.
  </verify>
  <done>
Unit tests verify get_events() and get_alarms() work correctly, including pagination parameters and truncation detection.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from unifi_scanner.api import UnifiClient; print('API methods available')"` - imports work
2. `pytest tests/test_api_client.py -v` - all tests pass
3. `python -m py_compile src/unifi_scanner/api/client.py` - no syntax errors
</verification>

<success_criteria>
- UnifiClient.get_events() retrieves events with pagination support
- UnifiClient.get_alarms() retrieves alarms with archived filter
- Truncation detection logs warning when API returns partial results
- Endpoints work for both UDM and self-hosted device types
- Unit tests cover happy path and edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/02-log-collection-parsing/02-01-SUMMARY.md`
</output>

---
phase: 08-enhanced-security
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/unifi_scanner/analysis/ips/remediation.py
  - src/unifi_scanner/reports/templates/threat_section.html
  - src/unifi_scanner/reports/templates/threat_section.txt
  - tests/test_ips_remediation.py
autonomous: true

must_haves:
  truths:
    - "Remediation templates provide severity-adjusted guidance"
    - "SEVERE threats get step-by-step remediation"
    - "MEDIUM threats get brief actionable advice"
    - "LOW threats get explanation only"
    - "Common false positives are noted"
  artifacts:
    - path: "src/unifi_scanner/analysis/ips/remediation.py"
      provides: "Category-specific remediation templates"
      exports: ["get_remediation", "IPS_REMEDIATION_TEMPLATES"]
    - path: "src/unifi_scanner/reports/templates/threat_section.html"
      provides: "HTML template for threat summary"
      contains: "Threats Detected"
    - path: "src/unifi_scanner/reports/templates/threat_section.txt"
      provides: "Plain text template for threat summary"
      min_lines: 30
  key_links:
    - from: "src/unifi_scanner/reports/templates/threat_section.html"
      to: "ips_analysis"
      via: "Jinja2 context variable"
      pattern: "ips_analysis"
---

<objective>
Create remediation templates and report sections for IPS analysis.

Purpose: Provide actionable, severity-adjusted guidance and display threat summaries in reports.
Output: Remediation templates and HTML/text sections for threat display.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-enhanced-security/08-RESEARCH.md
@.planning/phases/08-enhanced-security/08-CONTEXT.md

# Existing template patterns
@src/unifi_scanner/analysis/templates/remediation.py
@src/unifi_scanner/reports/templates/report.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IPS remediation templates</name>
  <files>
    src/unifi_scanner/analysis/ips/remediation.py
    tests/test_ips_remediation.py
  </files>
  <action>
    Create remediation.py with category-specific templates per CONTEXT.md decisions:

    Structure:
    ```python
    IPS_REMEDIATION_TEMPLATES = {
        "SCAN": {
            "severe": "1. Identify source IP {src_ip}...\n2. Check if internal...",
            "medium": "Port scans detected from {src_ip}. This is often routine...",
            "low": "Low-level scanning activity detected. Usually background noise.",
            "false_positive_note": None,
        },
        "MALWARE": {
            "severe": "1. IMMEDIATELY isolate {src_ip}...\n2. Run full malware scan...",
            "medium": "Potential malware communication from {src_ip}. Run scan...",
            "low": "Minor malware signature match. May be false positive.",
            "false_positive_note": None,
        },
        "POLICY": {
            "severe": "1. Review policy violation...\n2. Determine if legitimate...",
            "medium": "Policy violation detected. Verify if expected behavior.",
            "low": "Policy violation logged for audit purposes.",
            "false_positive_note": "Note: POLICY violations from streaming services (Netflix, YouTube) are common false positives.",
        },
        # Additional categories: EXPLOIT, DOS, COINMINING, P2P, TOR, PHISHING
    }

    def get_remediation(category: str, severity: Severity, context: dict) -> str:
        """Get formatted remediation for category and severity."""
    ```

    Include categories from RESEARCH.md. Create simple tests to verify template lookup and formatting.
  </action>
  <verify>
    ```bash
    pytest tests/test_ips_remediation.py -v
    python -c "from unifi_scanner.analysis.ips.remediation import get_remediation; print('OK')"
    ```
  </verify>
  <done>
    - Remediation templates exist for SCAN, MALWARE, POLICY, EXPLOIT, DOS, COINMINING, P2P, TOR, PHISHING
    - Each category has severe, medium, low templates
    - False positive notes included for common categories (POLICY, P2P)
    - get_remediation() returns formatted string with context substitution
  </done>
</task>

<task type="auto">
  <name>Task 2: Create threat section templates</name>
  <files>
    src/unifi_scanner/reports/templates/threat_section.html
    src/unifi_scanner/reports/templates/threat_section.txt
  </files>
  <action>
    Create Jinja2 templates for threat summary sections.

    HTML template structure (threat_section.html):
    ```jinja2
    {% if ips_analysis %}
    <div style="margin-top: 30px;">
        <h2 style="color: #333;">Security Threat Summary</h2>

        {# Detection mode warning if applicable #}
        {% if ips_analysis.detection_mode_note %}
        <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 12px;">
            <p style="margin: 0; color: #856404;">{{ ips_analysis.detection_mode_note }}</p>
        </div>
        {% endif %}

        {# Threats Detected section (first per CONTEXT.md) #}
        {% if ips_analysis.detected_threats %}
        <h3>Threats Detected</h3>
        {% for threat in ips_analysis.detected_threats %}
        <div style="margin-bottom: 15px; padding: 10px; border-left: 3px solid {{ severity_color(threat.severity) }};">
            <strong>{{ threat.category_friendly }}</strong>: {{ threat.description }} ({{ threat.count }} events)
            {% if threat.remediation %}
            <p style="margin-top: 8px; color: #666;">{{ threat.remediation }}</p>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}

        {# Threats Blocked section #}
        {% if ips_analysis.blocked_threats %}
        <h3>Threats Blocked</h3>
        {% for threat in ips_analysis.blocked_threats %}
        <div style="margin-bottom: 15px; padding: 10px; border-left: 3px solid #28a745;">
            <strong>{{ threat.category_friendly }}</strong>: {{ threat.description }} ({{ threat.count }} blocked)
        </div>
        {% endfor %}
        {% endif %}

        {# Top Threat Sources #}
        {% if ips_analysis.external_source_ips or ips_analysis.internal_source_ips %}
        <h3>Top Threat Sources</h3>

        {% if ips_analysis.external_source_ips %}
        <h4>External Threats</h4>
        {% for ip_summary in ips_analysis.external_source_ips %}
        <p>{{ ip_summary.ip }}: {{ ip_summary.total_events }} events ({{ ip_summary.category_breakdown | join(', ') }})</p>
        {% endfor %}
        {% endif %}

        {% if ips_analysis.internal_source_ips %}
        <h4>Internal Concerns</h4>
        {% for ip_summary in ips_analysis.internal_source_ips %}
        <p>{{ ip_summary.ip }}: {{ ip_summary.total_events }} events ({{ ip_summary.category_breakdown | join(', ') }})</p>
        {% endfor %}
        {% endif %}
        {% endif %}
    </div>
    {% endif %}
    ```

    Text template (threat_section.txt) - similar structure with ASCII formatting.

    Follow existing report.html styling patterns (inline CSS for email compatibility).
  </action>
  <verify>
    ```bash
    # Verify templates exist and are valid Jinja2
    python -c "
from jinja2 import Environment, FileSystemLoader
env = Environment(loader=FileSystemLoader('src/unifi_scanner/reports/templates'))
html = env.get_template('threat_section.html')
txt = env.get_template('threat_section.txt')
print('Templates valid')
"
    ```
  </verify>
  <done>
    - threat_section.html exists with proper styling
    - threat_section.txt exists with ASCII formatting
    - Both templates handle empty ips_analysis gracefully
    - Detection mode note displayed when present
    - Threats Detected section appears before Threats Blocked
    - External/Internal sources are separated
  </done>
</task>

</tasks>

<verification>
```bash
# Run all IPS-related tests
pytest tests/test_ips_*.py -v

# Verify templates can render with mock data
python -c "
from jinja2 import Environment, FileSystemLoader
env = Environment(loader=FileSystemLoader('src/unifi_scanner/reports/templates'))
template = env.get_template('threat_section.html')
# Mock minimal context
result = template.render(ips_analysis=None)
print('Empty render OK:', len(result) < 100)
"
```
</verification>

<success_criteria>
- Remediation templates cover all major ET categories
- Templates render correctly with mock data
- False positive notes appear for POLICY and P2P categories
- Severity-adjusted detail levels work (step-by-step for SEVERE, brief for MEDIUM, explanation for LOW)
</success_criteria>

<output>
After completion, create `.planning/phases/08-enhanced-security/08-03-SUMMARY.md`
</output>

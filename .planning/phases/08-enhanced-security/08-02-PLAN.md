---
phase: 08-enhanced-security
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/unifi_scanner/analysis/ips/analyzer.py
  - src/unifi_scanner/analysis/ips/aggregator.py
  - tests/test_ips_analyzer.py
autonomous: true

must_haves:
  truths:
    - "IPS events are grouped by blocked vs detected"
    - "Source IPs with 10+ events are highlighted"
    - "Internal and external IPs are separated"
    - "Events are deduplicated by signature+source_ip"
  artifacts:
    - path: "src/unifi_scanner/analysis/ips/analyzer.py"
      provides: "IPSAnalyzer class with process_events method"
      contains: "class IPSAnalyzer"
    - path: "src/unifi_scanner/analysis/ips/aggregator.py"
      provides: "IP aggregation utilities"
      exports: ["aggregate_source_ips", "SourceIPSummary"]
    - path: "tests/test_ips_analyzer.py"
      provides: "Analyzer and aggregation tests"
      min_lines: 100
  key_links:
    - from: "src/unifi_scanner/analysis/ips/analyzer.py"
      to: "aggregator.py"
      via: "uses aggregate_source_ips for IP summaries"
      pattern: "aggregate_source_ips"
    - from: "src/unifi_scanner/analysis/ips/analyzer.py"
      to: "models.py"
      via: "processes list of IPSEvent"
      pattern: "IPSEvent"
---

<objective>
Create IPSAnalyzer with threshold-based IP aggregation using TDD.

Purpose: Core analysis logic - separate blocked/detected events, aggregate by source IP, identify top threat sources.
Output: Working, tested IPSAnalyzer that produces structured threat analysis.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-enhanced-security/08-RESEARCH.md
@.planning/phases/08-enhanced-security/08-CONTEXT.md

# Will use models from 08-01 (parallel execution - define interface now)
@src/unifi_scanner/analysis/engine.py
</context>

<feature>
  <name>IPSAnalyzer with IP Aggregation</name>
  <files>
    src/unifi_scanner/analysis/ips/analyzer.py
    src/unifi_scanner/analysis/ips/aggregator.py
    tests/test_ips_analyzer.py
  </files>
  <behavior>
    IP aggregation (threshold=10):
    - 5 events from 192.168.1.50 -> NOT highlighted (below threshold)
    - 15 events from 192.168.1.50 -> highlighted with breakdown
    - Separate internal (RFC1918) from external IPs

    Event separation:
    - is_blocked=True events -> blocked_threats list
    - is_blocked=False events -> detected_threats list

    Deduplication:
    - Same signature + same source_ip within window -> count, not duplicate finding

    ThreatAnalysisResult structure:
    - blocked_threats: List[ThreatSummary]
    - detected_threats: List[ThreatSummary]
    - external_source_ips: List[SourceIPSummary]
    - internal_source_ips: List[SourceIPSummary]
    - detection_mode_note: Optional[str]  # Set if ALL events are detected-only

    ThreatSummary structure:
    - category_friendly: str
    - description: str
    - count: int
    - severity: Severity
    - sample_signature: str
    - source_ips: List[str]  # Unique IPs for this threat type
  </behavior>
  <implementation>
    1. Create tests/test_ips_analyzer.py with:
       - test_separate_blocked_detected
       - test_aggregate_by_threshold_includes_above
       - test_aggregate_by_threshold_excludes_below
       - test_internal_external_ip_separation
       - test_detection_mode_note_when_all_detected
       - test_no_detection_note_when_blocked_exists
       - test_deduplicate_same_signature_source
       - test_threat_summary_counts

    2. Create aggregator.py:
       - SourceIPSummary NamedTuple (ip, total_events, category_breakdown, is_internal, sample_signatures)
       - aggregate_source_ips(events, threshold=10) -> List[SourceIPSummary]
       - Uses ipaddress.ip_address().is_private for internal detection

    3. Create analyzer.py:
       - ThreatSummary dataclass
       - ThreatAnalysisResult dataclass
       - IPSAnalyzer class with:
         - __init__(event_threshold=10)
         - process_events(events: List[IPSEvent]) -> ThreatAnalysisResult
         - _separate_blocked_detected() -> Tuple[List, List]
         - _group_by_category() -> Dict[str, List[IPSEvent]]
         - _detect_detection_mode() -> Optional[str]
  </implementation>
</feature>

<verification>
```bash
# Run tests for analyzer
pytest tests/test_ips_analyzer.py -v

# Verify exports
python -c "from unifi_scanner.analysis.ips import IPSAnalyzer, ThreatAnalysisResult; print('OK')"
```
</verification>

<success_criteria>
- All tests pass
- IPSAnalyzer correctly separates blocked/detected
- Threshold-based IP aggregation works correctly
- Internal/external IP separation uses ipaddress stdlib
- Detection mode note appears only when all events are detected-only
</success_criteria>

<output>
After completion, create `.planning/phases/08-enhanced-security/08-02-SUMMARY.md`
</output>

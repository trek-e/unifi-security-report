---
phase: 08-enhanced-security
plan: 04
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - src/unifi_scanner/analysis/ips/__init__.py
  - src/unifi_scanner/reports/generator.py
  - src/unifi_scanner/reports/templates/report.html
  - src/unifi_scanner/reports/templates/report.txt
  - src/unifi_scanner/service.py
  - tests/test_ips_integration.py
autonomous: true

must_haves:
  truths:
    - "IPS analysis runs during report generation"
    - "Threat summary appears in HTML and text reports"
    - "IPSAnalyzer receives events from api_collector"
    - "Reports show severity-grouped findings with remediation"
  artifacts:
    - path: "src/unifi_scanner/reports/generator.py"
      provides: "Updated generator with IPS support"
      contains: "ips_analysis"
    - path: "src/unifi_scanner/reports/templates/report.html"
      provides: "Updated report including threat section"
      contains: "threat_section"
    - path: "tests/test_ips_integration.py"
      provides: "End-to-end IPS analysis tests"
      min_lines: 60
  key_links:
    - from: "src/unifi_scanner/service.py"
      to: "IPSAnalyzer"
      via: "instantiates analyzer for IPS events"
      pattern: "IPSAnalyzer"
    - from: "src/unifi_scanner/reports/generator.py"
      to: "threat_section.html"
      via: "includes template in report"
      pattern: "threat_section"
---

<objective>
Integrate IPSAnalyzer into service and report generation pipeline.

Purpose: Wire everything together so IPS analysis runs during report generation and results appear in reports.
Output: Working end-to-end IPS analysis with reports showing threat summaries.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-enhanced-security/08-RESEARCH.md
@.planning/phases/08-enhanced-security/08-CONTEXT.md

# Integration points
@src/unifi_scanner/service.py
@src/unifi_scanner/reports/generator.py
@src/unifi_scanner/logs/api_collector.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire IPSAnalyzer into report generation</name>
  <files>
    src/unifi_scanner/analysis/ips/__init__.py
    src/unifi_scanner/reports/generator.py
    src/unifi_scanner/reports/templates/report.html
    src/unifi_scanner/reports/templates/report.txt
  </files>
  <action>
    1. Update analysis/ips/__init__.py to export all public APIs:
       ```python
       from .models import IPSEvent
       from .analyzer import IPSAnalyzer, ThreatAnalysisResult, ThreatSummary
       from .aggregator import SourceIPSummary, aggregate_source_ips
       from .signature_parser import parse_signature_category, ET_CATEGORY_FRIENDLY_NAMES
       from .remediation import get_remediation, IPS_REMEDIATION_TEMPLATES

       __all__ = [
           "IPSEvent", "IPSAnalyzer", "ThreatAnalysisResult", "ThreatSummary",
           "SourceIPSummary", "aggregate_source_ips",
           "parse_signature_category", "ET_CATEGORY_FRIENDLY_NAMES",
           "get_remediation", "IPS_REMEDIATION_TEMPLATES",
       ]
       ```

    2. Update reports/generator.py:
       - Add method to build IPS analysis context
       - Add ips_analysis to template context in _build_context()
       - Handle case where IPS analysis is None (no events)

       ```python
       def _build_ips_context(self, ips_analysis: Optional[ThreatAnalysisResult]) -> Dict[str, Any]:
           """Build template context for IPS analysis."""
           if ips_analysis is None:
               return {}
           return {
               "ips_analysis": {
                   "detected_threats": [self._format_threat(t) for t in ips_analysis.detected_threats],
                   "blocked_threats": [self._format_threat(t) for t in ips_analysis.blocked_threats],
                   "external_source_ips": ips_analysis.external_source_ips,
                   "internal_source_ips": ips_analysis.internal_source_ips,
                   "detection_mode_note": ips_analysis.detection_mode_note,
               }
           }
       ```

    3. Update report.html to include threat_section.html:
       - Add `{% include 'threat_section.html' %}` after findings sections
       - Position before footer

    4. Update report.txt similarly with threat_section.txt inclusion.
  </action>
  <verify>
    ```bash
    # Verify imports work
    python -c "from unifi_scanner.analysis.ips import IPSAnalyzer, ThreatAnalysisResult; print('OK')"

    # Verify report generator can be imported
    python -c "from unifi_scanner.reports.generator import ReportGenerator; print('OK')"

    # Verify templates are syntactically valid
    python -c "
from unifi_scanner.reports.generator import ReportGenerator
gen = ReportGenerator()
print('Generator initialized:', gen is not None)
"
    ```
  </verify>
  <done>
    - All IPS module exports available from unifi_scanner.analysis.ips
    - ReportGenerator._build_context includes ips_analysis
    - report.html includes threat_section.html
    - report.txt includes threat_section.txt
    - Templates render without errors when ips_analysis is None
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests and service wiring</name>
  <files>
    src/unifi_scanner/service.py
    tests/test_ips_integration.py
  </files>
  <action>
    1. Update service.py to use IPSAnalyzer:
       - In the report generation flow, after collecting IPS events:
         ```python
         from unifi_scanner.analysis.ips import IPSAnalyzer, IPSEvent

         # Process IPS events separately from standard analysis
         ips_analyzer = IPSAnalyzer(event_threshold=10)
         ips_events = [IPSEvent.from_api_event(e) for e in raw_ips_events]
         ips_analysis = ips_analyzer.process_events(ips_events) if ips_events else None
         ```
       - Pass ips_analysis to ReportGenerator

    2. Create tests/test_ips_integration.py with end-to-end tests:
       ```python
       def test_ips_analysis_flows_to_report():
           """IPS events are analyzed and appear in report output."""

       def test_empty_ips_events_handled():
           """Reports generate correctly with no IPS events."""

       def test_blocked_and_detected_both_shown():
           """Both blocked and detected threats appear in report."""

       def test_source_ip_threshold_applied():
           """Only IPs with 10+ events appear in top sources."""

       def test_detection_mode_note_appears():
           """Detection mode note shows when all events are detected-only."""
       ```

    3. Use mock IPS event data that matches real UniFi API structure:
       ```python
       SAMPLE_IPS_EVENT = {
           "_id": "abc123",
           "timestamp": 1706234567890,
           "src_ip": "203.0.113.50",
           "dest_ip": "192.168.1.100",
           "proto": "TCP",
           "inner_alert": {
               "signature": "ET SCAN Nmap Scripting Engine User-Agent",
               "signature_id": 2009358,
               "category": "Attempted Information Leak",
               "severity": 2,
               "action": "blocked",
           }
       }
       ```
  </action>
  <verify>
    ```bash
    # Run integration tests
    pytest tests/test_ips_integration.py -v

    # Run all tests to ensure no regressions
    pytest tests/ -v --tb=short
    ```
  </verify>
  <done>
    - Integration tests pass
    - Service correctly wires IPSAnalyzer
    - Reports include IPS analysis when events exist
    - Reports render correctly when no IPS events
    - All existing tests continue to pass
  </done>
</task>

</tasks>

<verification>
```bash
# Full test suite
pytest tests/ -v

# Verify complete flow with mock
python -c "
from unifi_scanner.analysis.ips import IPSAnalyzer, IPSEvent

# Minimal event
event = {
    '_id': 'test1',
    'timestamp': 1706234567890,
    'src_ip': '203.0.113.50',
    'dest_ip': '192.168.1.100',
    'proto': 'TCP',
    'inner_alert': {
        'signature': 'ET SCAN Nmap',
        'signature_id': 123,
        'category': 'scan',
        'severity': 2,
        'action': 'blocked',
    }
}

ips_event = IPSEvent.from_api_event(event)
analyzer = IPSAnalyzer()
result = analyzer.process_events([ips_event])
print('Category:', ips_event.category_friendly)
print('Blocked:', ips_event.is_blocked)
print('Analysis complete:', result is not None)
"
```
</verification>

<success_criteria>
- All tests pass including integration tests
- IPSAnalyzer correctly processes sample events
- Reports include threat sections when IPS events exist
- Reports render correctly when no IPS events
- Detection mode note appears when applicable
- Blocked and detected threats are properly separated
</success_criteria>

<output>
After completion, create `.planning/phases/08-enhanced-security/08-04-SUMMARY.md`
</output>

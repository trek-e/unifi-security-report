---
phase: 08-enhanced-security
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/unifi_scanner/analysis/ips/__init__.py
  - src/unifi_scanner/analysis/ips/models.py
  - src/unifi_scanner/analysis/ips/signature_parser.py
  - tests/test_ips_models.py
autonomous: true

must_haves:
  truths:
    - "ET signature strings are parsed into category + friendly name + description"
    - "IPS action field correctly classifies blocked vs detected"
    - "IPSEvent model normalizes raw API events"
  artifacts:
    - path: "src/unifi_scanner/analysis/ips/models.py"
      provides: "IPSEvent pydantic model"
      contains: "class IPSEvent"
    - path: "src/unifi_scanner/analysis/ips/signature_parser.py"
      provides: "Signature category extraction"
      exports: ["parse_signature_category", "ET_CATEGORY_FRIENDLY_NAMES"]
    - path: "tests/test_ips_models.py"
      provides: "Model and parser tests"
      min_lines: 80
  key_links:
    - from: "src/unifi_scanner/analysis/ips/models.py"
      to: "signature_parser"
      via: "from_api_event calls parse_signature_category"
      pattern: "parse_signature_category"
---

<objective>
Create IPS event models and signature parser using TDD.

Purpose: Foundation for IPS analysis - parse Suricata ET signatures into friendly names and classify events as blocked/detected.
Output: Working, tested IPSEvent model and signature parser.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-enhanced-security/08-RESEARCH.md

# Existing patterns to follow
@src/unifi_scanner/models/log_entry.py
@src/unifi_scanner/models/finding.py
</context>

<feature>
  <name>IPS Models and Signature Parser</name>
  <files>
    src/unifi_scanner/analysis/ips/__init__.py
    src/unifi_scanner/analysis/ips/models.py
    src/unifi_scanner/analysis/ips/signature_parser.py
    tests/test_ips_models.py
  </files>
  <behavior>
    Signature parsing:
    - "ET SCAN Nmap Scripting Engine" -> ("SCAN", "Reconnaissance", "Nmap Scripting Engine")
    - "ET MALWARE Win32/Agent.ABC" -> ("MALWARE", "Malware Activity", "Win32/Agent.ABC")
    - "ET POLICY BitTorrent Traffic" -> ("POLICY", "Policy Violation", "BitTorrent Traffic")
    - "GPL ATTACK_RESPONSE id check" -> ("UNKNOWN", "Security Event", "GPL ATTACK_RESPONSE id check")

    Action classification:
    - "blocked", "drop", "reject" -> is_blocked = True
    - "allowed", "alert", "pass" -> is_blocked = False

    IPSEvent.from_api_event():
    - Handles nested inner_alert structure
    - Extracts src_ip, dest_ip, signature, action
    - Computes category_friendly and is_blocked
    - Uses pydantic for validation
  </behavior>
  <implementation>
    1. Create tests/test_ips_models.py with:
       - test_parse_et_scan_signature
       - test_parse_et_malware_signature
       - test_parse_non_et_signature
       - test_action_blocked_classification
       - test_action_detected_classification
       - test_ips_event_from_api_with_inner_alert
       - test_ips_event_from_api_flat_structure

    2. Create src/unifi_scanner/analysis/ips/ module:
       - __init__.py with exports
       - signature_parser.py with ET_SIGNATURE_PATTERN regex, ET_CATEGORY_FRIENDLY_NAMES dict, parse_signature_category() function
       - models.py with IPSEvent pydantic model including from_api_event() factory

    Category mapping (from RESEARCH.md):
    - SCAN -> Reconnaissance
    - MALWARE -> Malware Activity
    - POLICY -> Policy Violation
    - TROJAN -> Malware Activity (legacy mapping)
    - EXPLOIT -> Exploit Attempt
    - DOS -> Denial of Service
    - COINMINING -> Cryptocurrency Mining
    - PHISHING -> Phishing Attempt
    - TOR -> TOR Network Traffic
    - P2P -> Peer-to-Peer Traffic
    - (etc. - see RESEARCH.md for full list)
  </implementation>
</feature>

<verification>
```bash
# Run tests for this module
pytest tests/test_ips_models.py -v

# Verify module imports work
python -c "from unifi_scanner.analysis.ips import IPSEvent, parse_signature_category; print('OK')"
```
</verification>

<success_criteria>
- All tests pass
- IPSEvent model correctly parses sample IPS event JSON
- Signature parser correctly extracts ET categories
- Action classification works for blocked/detected
</success_criteria>

<output>
After completion, create `.planning/phases/08-enhanced-security/08-01-SUMMARY.md`
</output>

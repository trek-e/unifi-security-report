---
phase: 13-websocket-support
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - tests/test_websocket.py
  - src/unifi_scanner/api/websocket.py
autonomous: true

must_haves:
  truths:
    - "WebSocket event parsing correctly extracts WiFi events"
    - "Event buffer handles concurrent access safely"
    - "Client endpoint selection works for both UDM and self-hosted"
  artifacts:
    - path: "tests/test_websocket.py"
      provides: "Unit tests for WebSocket components"
      min_lines: 80
  key_links:
    - from: "tests/test_websocket.py"
      to: "src/unifi_scanner/api/websocket.py"
      via: "pytest test execution"
      pattern: "from unifi_scanner.api.websocket import"
---

<objective>
Test the WebSocket client components using TDD methodology.

Purpose: Ensure event parsing, buffer management, and endpoint selection work correctly
before integrating with the rest of the system. TDD forces us to think about edge cases
and error handling upfront.

Output:
- Comprehensive test suite for WebSocket components
- Validated event parsing logic
- Verified thread-safe buffer behavior
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-websocket-support/13-RESEARCH.md
@src/unifi_scanner/api/websocket.py
@src/unifi_scanner/models/__init__.py
</context>

<feature>
  <name>WebSocket Event Parsing and Buffer Tests</name>
  <files>tests/test_websocket.py, src/unifi_scanner/api/websocket.py</files>
  <behavior>
**Event Parsing (parse_unifi_event):**
- Valid wu.connected event JSON -> BufferedEvent with event_type="wu.connected"
- Valid wu.roam event JSON -> BufferedEvent with event_type="wu.roam"
- Valid sta:sync event JSON -> BufferedEvent with event_type="sta:sync"
- Non-WiFi event (e.g., "device:sync") -> None
- Invalid JSON -> None
- Empty message -> None

**Event Buffer (WebSocketEventBuffer):**
- add() then drain() returns the event
- Multiple add() then drain() returns all events in order
- drain() clears buffer (second drain() returns empty list)
- Buffer respects maxsize (oldest events dropped when full)

**Client Endpoint Selection (UnifiWebSocketClient.endpoint property):**
- DeviceType.UDM_PRO -> wss://host/proxy/network/wss/s/site/events
- DeviceType.SELF_HOSTED -> wss://host/wss/s/site/events
- https:// base_url -> wss://

**Test cases (input -> expected output):**
```python
# Event parsing
'{"meta":{"message":"wu.connected"},"data":[{"mac":"aa:bb:cc:dd:ee:ff"}]}' -> BufferedEvent(event_type="wu.connected")
'{"meta":{"message":"wu.roam"},"data":[{"ap":"AP-1","ap_to":"AP-2"}]}' -> BufferedEvent(event_type="wu.roam")
'{"meta":{"message":"device:sync"},"data":[{}]}' -> None
'invalid json' -> None

# Buffer
buffer.add(event1); buffer.add(event2); buffer.drain() -> [event1, event2]
buffer.drain() -> []  # After drain, buffer is empty
```
  </behavior>
  <implementation>
Write tests in tests/test_websocket.py covering:

1. TestParseUnifiEvent class:
   - test_parse_wifi_connected_event
   - test_parse_wifi_roam_event
   - test_parse_wifi_roam_radio_event
   - test_parse_wifi_disconnected_event
   - test_parse_sta_sync_event
   - test_parse_non_wifi_event_returns_none
   - test_parse_invalid_json_returns_none
   - test_parse_empty_message_returns_none

2. TestWebSocketEventBuffer class:
   - test_add_and_drain_single_event
   - test_add_and_drain_multiple_events
   - test_drain_clears_buffer
   - test_buffer_respects_maxsize
   - test_thread_safety (use threading to verify concurrent access)

3. TestUnifiWebSocketClientEndpoint class:
   - test_endpoint_udm_pro
   - test_endpoint_self_hosted
   - test_https_to_wss_conversion

Use pytest fixtures for common test data. Mock websockets library for connection tests.
  </implementation>
</feature>

<verification>
Run the test suite:
```bash
pytest tests/test_websocket.py -v
```

All tests should pass. Check coverage:
```bash
pytest tests/test_websocket.py --cov=src/unifi_scanner/api/websocket --cov-report=term-missing
```
</verification>

<success_criteria>
- All unit tests pass
- Event parsing handles all WiFi event types correctly
- Buffer add/drain cycle works as expected
- Endpoint selection matches device type
- Thread safety verified for buffer
</success_criteria>

<output>
After completion, create `.planning/phases/13-websocket-support/13-02-SUMMARY.md`
</output>

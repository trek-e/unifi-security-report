---
phase: 13-websocket-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/unifi_scanner/api/websocket.py
  - src/unifi_scanner/api/__init__.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "WebSocket client connects to UniFi controller using REST session cookies"
    - "WebSocket client handles self-signed SSL certificates"
    - "WebSocket client reconnects automatically after disconnection"
  artifacts:
    - path: "src/unifi_scanner/api/websocket.py"
      provides: "UnifiWebSocketClient class"
      exports: ["UnifiWebSocketClient", "WebSocketEventBuffer", "BufferedEvent"]
      min_lines: 100
    - path: "pyproject.toml"
      provides: "websockets dependency"
      contains: "websockets"
  key_links:
    - from: "src/unifi_scanner/api/websocket.py"
      to: "websockets library"
      via: "async connect with cookie header"
      pattern: "connect.*additional_headers.*Cookie"
---

<objective>
Create the core WebSocket client infrastructure for UniFi event streaming.

Purpose: Establish the foundational WebSocket client that can connect to UniFi controllers
using authentication cookies from the existing REST client session. This enables real-time
event streaming for UniFi Network 10.x+ where REST `/stat/event` no longer returns WiFi events.

Output:
- UnifiWebSocketClient class with cookie-based authentication
- WebSocketEventBuffer for thread-safe event collection
- BufferedEvent dataclass for parsed events
- websockets dependency added to project
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-websocket-support/13-RESEARCH.md

# Existing code to integrate with
@src/unifi_scanner/api/client.py
@src/unifi_scanner/api/endpoints.py
@src/unifi_scanner/models/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add websockets dependency and update Python version</name>
  <files>pyproject.toml</files>
  <action>
Add websockets>=14.0 to dependencies list. Use 14.x (not 16.x) to maintain Python 3.9
compatibility since the project supports Python 3.9+.

The websockets library provides:
- Async WebSocket client with auto-reconnection
- Built-in ping/pong keepalive
- Clean exception handling for connection issues

Note: websockets 16.x requires Python 3.10+, so we use 14.x for broader compatibility.
  </action>
  <verify>
Run `pip install -e ".[dev]"` and verify websockets is installed with `python -c "import websockets; print(websockets.__version__)"`.
  </verify>
  <done>
websockets>=14.0 appears in pyproject.toml dependencies and installs successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WebSocket client with event buffer</name>
  <files>src/unifi_scanner/api/websocket.py, src/unifi_scanner/api/__init__.py</files>
  <action>
Create src/unifi_scanner/api/websocket.py with:

1. **BufferedEvent dataclass:**
   - timestamp: datetime (when event received)
   - event_type: str (e.g., "wu.roam", "wu.connected")
   - data: dict[str, Any] (raw event payload)

2. **WebSocketEventBuffer class:**
   - Thread-safe buffer using collections.deque with maxsize=10000
   - Uses threading.Lock (not asyncio.Lock) for cross-thread safety
   - add(event) method to append events
   - drain() method to return and clear all events (for processing)

3. **UnifiWebSocketClient class:**
   - Constructor takes: base_url, site, cookies (dict), verify_ssl (bool)
   - Computes WebSocket endpoint: wss://{host}/proxy/network/wss/s/{site}/events for UDM
     or wss://{host}/wss/s/{site}/events for self-hosted
   - Device type parameter to choose correct endpoint prefix
   - _get_ssl_context() returns ssl.SSLContext with CERT_NONE if verify_ssl=False
   - connect() async method that returns bool (True if connected, False if unavailable)
   - listen(on_event: Callable) async method that loops receiving messages
   - Uses websockets.connect() with additional_headers for Cookie
   - Handles websockets.exceptions.ConnectionClosed with automatic reconnection
   - stop() async method to gracefully close connection

4. **parse_unifi_event(raw_message: str) function:**
   - Parses JSON message from WebSocket
   - Extracts event type from meta.message field
   - Filters for WiFi event types: sta:sync, wu.connected, wu.disconnected, wu.roam, wu.roam_radio
   - Returns BufferedEvent or None if not a WiFi event

Use structlog for logging connection events, disconnections, and errors.

Update src/unifi_scanner/api/__init__.py to export UnifiWebSocketClient, WebSocketEventBuffer, BufferedEvent.
  </action>
  <verify>
Run tests:
```bash
python -c "from unifi_scanner.api import UnifiWebSocketClient, WebSocketEventBuffer, BufferedEvent; print('Imports OK')"
```

Run mypy:
```bash
mypy src/unifi_scanner/api/websocket.py --ignore-missing-imports
```
  </verify>
  <done>
UnifiWebSocketClient class exists with connect(), listen(), stop() methods.
WebSocketEventBuffer class exists with add(), drain() methods.
BufferedEvent dataclass exists with timestamp, event_type, data fields.
All classes are exported from unifi_scanner.api module.
  </done>
</task>

</tasks>

<verification>
1. `python -c "import websockets"` succeeds
2. `python -c "from unifi_scanner.api import UnifiWebSocketClient"` succeeds
3. `mypy src/unifi_scanner/api/websocket.py --ignore-missing-imports` passes
4. `ruff check src/unifi_scanner/api/websocket.py` passes
</verification>

<success_criteria>
- websockets library installed and importable
- UnifiWebSocketClient class exists with connect/listen/stop methods
- WebSocketEventBuffer class exists with add/drain methods
- BufferedEvent dataclass exists with required fields
- All new code passes mypy and ruff checks
</success_criteria>

<output>
After completion, create `.planning/phases/13-websocket-support/13-01-SUMMARY.md`
</output>

---
phase: 13-websocket-support
plan: 05
type: execute
wave: 3
depends_on: ["13-03"]
files_modified:
  - src/unifi_scanner/__main__.py
  - src/unifi_scanner/config/settings.py
autonomous: true

must_haves:
  truths:
    - "Service starts WebSocket manager after REST authentication"
    - "WebSocket can be disabled via configuration"
    - "Service shuts down WebSocket cleanly on exit"
  artifacts:
    - path: "src/unifi_scanner/__main__.py"
      provides: "WebSocket lifecycle management"
      contains: "WebSocketManager"
    - path: "src/unifi_scanner/config/settings.py"
      provides: "WebSocket configuration options"
      contains: "websocket_enabled"
  key_links:
    - from: "src/unifi_scanner/__main__.py"
      to: "src/unifi_scanner/api/ws_manager.py"
      via: "WebSocketManager start/stop"
      pattern: "ws_manager.start"
---

<objective>
Wire WebSocket manager into service lifecycle and add configuration.

Purpose: The service needs to start the WebSocket manager after REST authentication
succeeds, keep it running in the background during scheduled reports, and shut it
down cleanly on exit. Configuration allows users to disable WebSocket if needed.

Output:
- WebSocket manager integrated into main service lifecycle
- Configuration option to enable/disable WebSocket
- Clean shutdown handling
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-websocket-support/13-RESEARCH.md
@.planning/phases/13-websocket-support/13-03-SUMMARY.md

# Files to modify
@src/unifi_scanner/__main__.py
@src/unifi_scanner/config/settings.py

# Files to reference
@src/unifi_scanner/api/ws_manager.py
@src/unifi_scanner/api/client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WebSocket configuration options</name>
  <files>src/unifi_scanner/config/settings.py</files>
  <action>
Add WebSocket configuration to UnifiSettings (or AppSettings, whichever is appropriate):

**New fields:**
- websocket_enabled: bool = True
  - Environment variable: UNIFI_WEBSOCKET_ENABLED
  - Default True (try WebSocket by default)
  - Set to False to disable WebSocket and use REST-only

- websocket_buffer_size: int = 10000
  - Environment variable: UNIFI_WEBSOCKET_BUFFER_SIZE
  - Maximum events to buffer between report generations
  - Default 10000 should handle hours of moderate activity

Add Field() with description for each setting explaining:
- websocket_enabled: "Enable WebSocket for real-time WiFi events (required for UniFi 10.x+)"
- websocket_buffer_size: "Maximum WebSocket events to buffer between reports"

Add validation:
- websocket_buffer_size must be >= 100 and <= 100000
  </action>
  <verify>
```bash
python -c "from unifi_scanner.config import UnifiSettings; s = UnifiSettings(); print(f'ws_enabled={s.websocket_enabled}, buffer={s.websocket_buffer_size}')"
```
  </verify>
  <done>
websocket_enabled and websocket_buffer_size fields exist in settings.
Fields have environment variable support.
websocket_buffer_size has range validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate WebSocket into service lifecycle</name>
  <files>src/unifi_scanner/__main__.py</files>
  <action>
Update the main service to manage WebSocket lifecycle:

**Add imports:**
- from unifi_scanner.api import WebSocketManager

**In service initialization (after REST client connects):**
1. Check if settings.websocket_enabled is True
2. If enabled:
   - Create WebSocketManager instance
   - Get cookies from client.get_session_cookies()
   - Call ws_manager.start(
       base_url=client.base_url,
       site=site,
       cookies=cookies,
       device_type=client.device_type,
       verify_ssl=settings.verify_ssl
     )
   - Log "websocket_started"
3. If disabled:
   - Log "websocket_disabled" at info level
   - Set ws_manager = None

**Pass ws_manager to LogCollector:**
- Update LogCollector instantiation to include ws_manager parameter
- This enables the collector to retrieve WebSocket events

**In shutdown handling:**
1. If ws_manager is not None and is_running():
   - Call ws_manager.stop()
   - Log "websocket_stopped"
2. Handle gracefully if already stopped

**Error handling:**
- If WebSocket fails to start, log warning and continue with REST-only
- WebSocket is optional enhancement, not required for operation

The key integration point is likely in the report generation function where
LogCollector is created. The ws_manager should be passed there.
  </action>
  <verify>
```bash
# Verify imports work
python -c "from unifi_scanner.__main__ import main; print('Import OK')"

# Verify WebSocket config is respected
UNIFI_WEBSOCKET_ENABLED=false python -c "from unifi_scanner.config import UnifiSettings; s = UnifiSettings(); print(f'enabled={s.websocket_enabled}')"
```
  </verify>
  <done>
Service creates WebSocketManager when enabled.
WebSocket starts after REST authentication.
ws_manager is passed to LogCollector.
Clean shutdown stops WebSocket manager.
WebSocket can be disabled via configuration.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from unifi_scanner.config import UnifiSettings; print(hasattr(UnifiSettings, 'model_fields') and 'websocket_enabled' in UnifiSettings.model_fields)"` returns True
2. `UNIFI_WEBSOCKET_ENABLED=false python -c "from unifi_scanner.config import UnifiSettings; print(UnifiSettings().websocket_enabled)"` returns False
3. `mypy src/unifi_scanner/__main__.py src/unifi_scanner/config/settings.py --ignore-missing-imports` passes
4. `ruff check src/unifi_scanner/` passes
5. `pytest tests/ -v` - all tests pass
</verification>

<success_criteria>
- websocket_enabled config option exists and defaults to True
- websocket_buffer_size config option exists with validation
- Service starts WebSocket after REST auth when enabled
- Service passes ws_manager to LogCollector
- Service stops WebSocket cleanly on shutdown
- WebSocket disabled via config results in REST-only operation
</success_criteria>

<output>
After completion, create `.planning/phases/13-websocket-support/13-05-SUMMARY.md`
</output>

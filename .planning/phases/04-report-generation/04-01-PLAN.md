---
phase: 04-report-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/unifi_scanner/reports/__init__.py
  - src/unifi_scanner/reports/generator.py
  - src/unifi_scanner/reports/templates/.gitkeep
  - tests/test_reports_generator.py
autonomous: true

must_haves:
  truths:
    - "Jinja2 is installed as a project dependency"
    - "ReportGenerator can create a Jinja2 environment with PackageLoader"
    - "Templates load from src/unifi_scanner/reports/templates/ directory"
    - "Autoescape is enabled for HTML/XML files"
  artifacts:
    - path: "src/unifi_scanner/reports/__init__.py"
      provides: "Reports module initialization"
      exports: ["ReportGenerator"]
    - path: "src/unifi_scanner/reports/generator.py"
      provides: "ReportGenerator class with Jinja2 environment"
      min_lines: 40
    - path: "tests/test_reports_generator.py"
      provides: "Tests for ReportGenerator foundation"
      min_lines: 30
  key_links:
    - from: "src/unifi_scanner/reports/generator.py"
      to: "jinja2"
      via: "Environment, PackageLoader, select_autoescape imports"
      pattern: "from jinja2 import"
    - from: "src/unifi_scanner/reports/generator.py"
      to: "src/unifi_scanner/analysis/formatter.py"
      via: "FindingFormatter import for reuse"
      pattern: "from unifi_scanner.analysis.formatter import FindingFormatter"
---

<objective>
Set up Jinja2 template system with ReportGenerator class foundation.

Purpose: Establish the templating infrastructure that HTML and plain text report generation will build upon. The ReportGenerator will orchestrate template rendering and compose with the existing FindingFormatter.

Output: Working `reports` module with ReportGenerator class, Jinja2 environment configured with PackageLoader and autoescape, and a test suite verifying the foundation.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-report-generation/04-RESEARCH.md
@.planning/phases/04-report-generation/04-CONTEXT.md
@src/unifi_scanner/analysis/formatter.py
@src/unifi_scanner/models/finding.py
@src/unifi_scanner/models/report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Jinja2 dependency and create reports module structure</name>
  <files>
    - pyproject.toml
    - src/unifi_scanner/reports/__init__.py
    - src/unifi_scanner/reports/templates/.gitkeep
  </files>
  <action>
1. Add Jinja2 to pyproject.toml dependencies:
   ```toml
   "Jinja2>=3.1.6",
   ```
   Add after existing dependencies, maintain alphabetical order if applicable.

2. Create reports module directory structure:
   - `src/unifi_scanner/reports/__init__.py`
   - `src/unifi_scanner/reports/templates/` directory with `.gitkeep`

3. In `__init__.py`, prepare for ReportGenerator export:
   ```python
   """Report generation module for UniFi Scanner.

   Provides HTML and plain text report generation from analysis findings
   using Jinja2 templates.
   """

   from .generator import ReportGenerator

   __all__ = ["ReportGenerator"]
   ```

4. Run `pip install -e .` to install the new dependency.
  </action>
  <verify>
    - `python -c "import jinja2; print(jinja2.__version__)"` shows 3.1.x
    - `ls src/unifi_scanner/reports/` shows `__init__.py`, `templates/`
  </verify>
  <done>Jinja2 installed, reports module structure exists with templates directory</done>
</task>

<task type="auto">
  <name>Task 2: Implement ReportGenerator class with Jinja2 environment</name>
  <files>src/unifi_scanner/reports/generator.py</files>
  <action>
Create ReportGenerator class that:

1. Imports:
   ```python
   from jinja2 import Environment, PackageLoader, select_autoescape
   from unifi_scanner.analysis.formatter import FindingFormatter
   from unifi_scanner.models.report import Report
   ```

2. Creates Jinja2 environment in `__init__`:
   - Use `PackageLoader("unifi_scanner.reports", "templates")`
   - Enable autoescape with `select_autoescape(["html", "xml"])`
   - Set `trim_blocks=True` and `lstrip_blocks=True` for cleaner output

3. Initialize with configurable options:
   - `display_timezone: str = "UTC"` - passed to FindingFormatter
   - `report_title: str = "UniFi Network Report"` - default title

4. Add internal helper `_build_context(self, report: Report) -> dict`:
   - Use `self.formatter.format_grouped_findings(report.findings)` to group findings
   - Return dict with: report_title, site_name, period_start, period_end,
     generated_at, severe_findings, medium_findings, low_findings, counts dict

5. Add stub methods for future plans:
   - `generate_html(self, report: Report) -> str` - raises NotImplementedError with message "HTML template not yet implemented"
   - `generate_text(self, report: Report) -> str` - raises NotImplementedError with message "Text template not yet implemented"

Type hints required for all methods. Docstrings for class and public methods.
  </action>
  <verify>
    - `python -c "from unifi_scanner.reports import ReportGenerator; rg = ReportGenerator(); print(rg.env)"` shows Jinja2 Environment object
    - `ruff check src/unifi_scanner/reports/generator.py` passes
  </verify>
  <done>ReportGenerator class exists with Jinja2 environment and FindingFormatter composition</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for ReportGenerator foundation</name>
  <files>tests/test_reports_generator.py</files>
  <action>
Create test file with:

1. Fixtures:
   - `sample_findings` - list of 3 Finding objects (1 severe, 1 medium, 1 low) with different categories
   - `sample_report` - Report object containing sample_findings

2. Test cases:
   - `test_report_generator_creates_environment` - verify env is Jinja2 Environment
   - `test_report_generator_has_package_loader` - verify loader is PackageLoader for "unifi_scanner.reports"
   - `test_report_generator_autoescape_enabled` - verify autoescape is True for .html files
   - `test_report_generator_uses_formatter` - verify self.formatter is FindingFormatter instance
   - `test_build_context_groups_findings` - verify _build_context returns correct structure with severe/medium/low grouped
   - `test_build_context_includes_counts` - verify counts dict has correct severe_count, medium_count, low_count, total
   - `test_generate_html_not_implemented` - verify raises NotImplementedError
   - `test_generate_text_not_implemented` - verify raises NotImplementedError
   - `test_custom_timezone_passed_to_formatter` - verify formatter.display_timezone matches init param
   - `test_custom_report_title` - verify report_title stored on instance

Use pytest fixtures, standard assertions.
  </action>
  <verify>`pytest tests/test_reports_generator.py -v` - all tests pass</verify>
  <done>Test suite validates ReportGenerator foundation with 10+ passing tests</done>
</task>

</tasks>

<verification>
- `pip list | grep -i jinja` shows Jinja2 3.1.x installed
- `python -c "from unifi_scanner.reports import ReportGenerator"` imports without error
- `pytest tests/test_reports_generator.py -v` all tests pass
- `ruff check src/unifi_scanner/reports/` no linting errors
</verification>

<success_criteria>
1. Jinja2>=3.1.6 is in pyproject.toml dependencies and installed
2. ReportGenerator class creates valid Jinja2 Environment with PackageLoader
3. Autoescape enabled for HTML/XML files (security default)
4. ReportGenerator composes with existing FindingFormatter (not reimplementing)
5. _build_context correctly groups findings by severity
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-report-generation/04-01-SUMMARY.md`
</output>

---
phase: 04-report-generation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/unifi_scanner/reports/templates/base.html
  - src/unifi_scanner/reports/templates/report.html
  - src/unifi_scanner/reports/templates/components/executive_summary.html
  - src/unifi_scanner/reports/templates/components/severity_section.html
  - src/unifi_scanner/reports/templates/components/finding_card.html
  - src/unifi_scanner/reports/generator.py
  - tests/test_reports_html.py
autonomous: true

must_haves:
  truths:
    - "ReportGenerator.generate_html() returns valid HTML string"
    - "HTML report displays SEVERE findings first, then MEDIUM, then LOW"
    - "LOW findings are collapsed by default with checkbox toggle"
    - "Executive summary shows counts by severity"
    - "Severity badges use correct colors (red SEVERE, orange MEDIUM, gray LOW)"
    - "All CSS is inline for email compatibility"
  artifacts:
    - path: "src/unifi_scanner/reports/templates/base.html"
      provides: "Base template with CSS and structure"
      contains: "<!DOCTYPE html>"
    - path: "src/unifi_scanner/reports/templates/report.html"
      provides: "Main report template extending base"
      contains: "{% extends"
    - path: "src/unifi_scanner/reports/templates/components/executive_summary.html"
      provides: "Summary section with counts"
      contains: "severe_count"
    - path: "src/unifi_scanner/reports/templates/components/severity_section.html"
      provides: "Severity section wrapper"
      contains: "{% for finding"
    - path: "src/unifi_scanner/reports/templates/components/finding_card.html"
      provides: "Individual finding display"
      contains: "remediation"
    - path: "tests/test_reports_html.py"
      provides: "HTML generation tests"
      min_lines: 60
  key_links:
    - from: "src/unifi_scanner/reports/generator.py"
      to: "src/unifi_scanner/reports/templates/report.html"
      via: "env.get_template('report.html')"
      pattern: "get_template.*report\\.html"
    - from: "src/unifi_scanner/reports/templates/report.html"
      to: "src/unifi_scanner/reports/templates/base.html"
      via: "{% extends 'base.html' %}"
      pattern: "extends.*base\\.html"
---

<objective>
Create HTML report templates with UniFi-inspired styling and email compatibility.

Purpose: Generate professional HTML reports that can be viewed in browsers and email clients. Reports organize findings by severity (SEVERE first), include an executive summary, and use the checkbox pattern for collapsible LOW findings section.

Output: Complete HTML template system with base template, report template, reusable components, and working generate_html() method in ReportGenerator.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-report-generation/04-RESEARCH.md
@.planning/phases/04-report-generation/04-CONTEXT.md
@.planning/phases/04-report-generation/04-01-SUMMARY.md
@src/unifi_scanner/reports/generator.py
@src/unifi_scanner/analysis/formatter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create base template with UniFi-inspired styling</name>
  <files>src/unifi_scanner/reports/templates/base.html</files>
  <action>
Create base.html with:

1. DOCTYPE and HTML5 structure with lang="en"
2. Meta tags: charset UTF-8, viewport for mobile
3. Title block: `{% block title %}{{ report_title }}{% endblock %}`

4. Embedded `<style>` block for clients that support it (progressive enhancement):
   - CSS reset basics
   - UniFi brand colors: #2282FF (UniFi blue), #0559C9 (darker blue)
   - Severity colors: #dc3545 (red/severe), #fd7e14 (orange/medium), #6c757d (gray/low)
   - Font stack: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif
   - Checkbox toggle styles for LOW section collapse:
     ```css
     .low-content { display: none; }
     #toggle-low:checked ~ .low-content { display: block; }
     #toggle-low { position: absolute; left: -9999px; }
     ```
   - Media query for mobile responsiveness (max-width: 600px)

5. Body with table-based layout (600px max-width, centered):
   - Header block
   - Content block
   - Footer block with "Generated by UniFi Scanner"

Use INLINE styles on ALL elements that need styling (email compatibility).
The `<style>` block is progressive enhancement only.

Template blocks to define:
- `{% block title %}`
- `{% block header %}`
- `{% block content %}`
- `{% block footer %}`
  </action>
  <verify>
    - File exists at `src/unifi_scanner/reports/templates/base.html`
    - Contains `<!DOCTYPE html>`, inline styles, table layout
    - Contains severity color definitions inline
  </verify>
  <done>Base template exists with UniFi styling, email-safe table layout, and CSS toggle for collapsible sections</done>
</task>

<task type="auto">
  <name>Task 2: Create report template and component templates</name>
  <files>
    - src/unifi_scanner/reports/templates/report.html
    - src/unifi_scanner/reports/templates/components/executive_summary.html
    - src/unifi_scanner/reports/templates/components/severity_section.html
    - src/unifi_scanner/reports/templates/components/finding_card.html
  </files>
  <action>
1. Create `report.html`:
   - `{% extends "base.html" %}`
   - Block header: Report title, site name, period covered, generated timestamp
   - Block content:
     - Include executive_summary.html
     - SEVERE section (if severe_findings): include severity_section.html with severity="severe", findings=severe_findings
     - MEDIUM section (if medium_findings): include severity_section.html with severity="medium", findings=medium_findings
     - LOW section (if low_findings): Wrap in checkbox toggle pattern:
       ```jinja
       <input type="checkbox" id="toggle-low" />
       <label for="toggle-low">Show LOW severity findings ({{ counts.low }})</label>
       <div class="low-content">
         {% include "components/severity_section.html" with context %}
       </div>
       ```

2. Create `components/executive_summary.html`:
   - Summary box with background color
   - "Executive Summary" heading
   - Counts: "{{ counts.severe }} Severe, {{ counts.medium }} Medium, {{ counts.low }} Low"
   - Total: "{{ counts.total }} findings total"
   - If actionable findings exist (severe with remediation), show "Action Required" callout

3. Create `components/severity_section.html`:
   - Section heading with severity name and count
   - Severity badge with appropriate color (inline style)
   - Loop over findings: `{% for finding in findings %}`
   - Include finding_card.html for each

4. Create `components/finding_card.html`:
   - Card container with border-left colored by severity
   - Title with severity badge (inline colored span)
   - Recurring badge if `finding.is_recurring`
   - Device info: `{{ finding.device_display }}`
   - Occurrence summary: `{{ finding.occurrence_summary }}`
   - Description (full for SEVERE/MEDIUM, omit for LOW per CONTEXT.md tiered detail)
   - Remediation section (only if finding.remediation exists AND severity is severe/medium):
     - Styled box with numbered steps
     - Blue left border per research

All templates must use INLINE styles on elements for email compatibility.
  </action>
  <verify>
    - All 4 template files exist in correct locations
    - `report.html` extends base.html
    - Components use inline styles
  </verify>
  <done>Complete template hierarchy: base -> report -> components (summary, section, card)</done>
</task>

<task type="auto">
  <name>Task 3: Implement generate_html() and add tests</name>
  <files>
    - src/unifi_scanner/reports/generator.py
    - tests/test_reports_html.py
  </files>
  <action>
1. Update `generator.py`:
   - Replace NotImplementedError stub in `generate_html()`:
     ```python
     def generate_html(self, report: Report) -> str:
         """Generate HTML report from Report model.

         Args:
             report: Report object containing findings to render

         Returns:
             Complete HTML document as string
         """
         template = self.env.get_template("report.html")
         context = self._build_context(report)
         return template.render(**context)
     ```

   - Update `_build_context()` to format timestamps for display:
     - `period_start_display`: formatted period_start
     - `period_end_display`: formatted period_end
     - `generated_at_display`: formatted generated_at

2. Create `tests/test_reports_html.py`:

   Fixtures:
   - `sample_findings_mixed` - 2 severe, 2 medium, 3 low findings
   - `sample_report_full` - Report with mixed findings

   Test cases:
   - `test_generate_html_returns_string` - returns str type
   - `test_generate_html_contains_doctype` - contains "<!DOCTYPE html>"
   - `test_generate_html_contains_title` - contains report title
   - `test_generate_html_contains_site_name` - contains site_name
   - `test_generate_html_severe_before_medium` - SEVERE section appears before MEDIUM in output
   - `test_generate_html_medium_before_low` - MEDIUM section appears before LOW in output
   - `test_generate_html_executive_summary_counts` - contains all three severity counts
   - `test_generate_html_severity_badges` - contains severity badge spans with colors
   - `test_generate_html_recurring_badge` - recurring finding shows [Recurring] badge
   - `test_generate_html_remediation_displayed` - severe finding remediation appears in output
   - `test_generate_html_low_toggle_checkbox` - contains checkbox input for LOW toggle
   - `test_generate_html_no_severe_section_when_empty` - no SEVERE heading when no severe findings
   - `test_generate_html_escapes_html_in_content` - XSS test: < and > in finding title are escaped

Use string assertions (in operator, find()) to verify HTML content.
  </action>
  <verify>
    - `pytest tests/test_reports_html.py -v` - all tests pass
    - `python -c "from unifi_scanner.reports import ReportGenerator; from unifi_scanner.models.report import Report; from datetime import datetime; r = Report(period_start=datetime.now(), period_end=datetime.now(), site_name='Test', controller_type='udm_pro', findings=[]); rg = ReportGenerator(); print(len(rg.generate_html(r)))"` - returns HTML length
  </verify>
  <done>generate_html() produces valid HTML with severity ordering, executive summary, collapsible LOW section</done>
</task>

</tasks>

<verification>
- All template files exist in `src/unifi_scanner/reports/templates/`
- `pytest tests/test_reports_html.py -v` all tests pass
- Manual inspection: `python -c "..."` generates readable HTML
- HTML contains inline styles (grep for 'style=' shows many matches)
- LOW section has checkbox toggle mechanism
</verification>

<success_criteria>
1. generate_html() returns complete HTML document
2. SEVERE findings appear first, then MEDIUM, then LOW
3. Executive summary shows counts for each severity level
4. Severity badges use correct colors (red/orange/gray)
5. LOW findings section is collapsible via checkbox pattern
6. All CSS is inline on elements (email compatible)
7. Remediation steps displayed for SEVERE/MEDIUM findings
8. HTML escaping prevents XSS (autoescape working)
</success_criteria>

<output>
After completion, create `.planning/phases/04-report-generation/04-02-SUMMARY.md`
</output>

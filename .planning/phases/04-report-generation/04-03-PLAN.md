---
phase: 04-report-generation
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/unifi_scanner/reports/templates/report.txt
  - src/unifi_scanner/reports/generator.py
  - tests/test_reports_text.py
autonomous: true

must_haves:
  truths:
    - "ReportGenerator.generate_text() returns plain text string"
    - "Text report displays SEVERE findings first, then MEDIUM, then LOW"
    - "SEVERE findings show full detail (title, description, occurrence, remediation)"
    - "MEDIUM findings show summary (title, brief description, occurrence, remediation)"
    - "LOW findings show one-liner (title and occurrence count only)"
    - "Executive summary shows counts by severity"
  artifacts:
    - path: "src/unifi_scanner/reports/templates/report.txt"
      provides: "Plain text report template"
      contains: "SEVERE FINDINGS"
    - path: "src/unifi_scanner/reports/generator.py"
      provides: "Updated with generate_text() implementation"
      contains: "report.txt"
    - path: "tests/test_reports_text.py"
      provides: "Text generation tests"
      min_lines: 50
  key_links:
    - from: "src/unifi_scanner/reports/generator.py"
      to: "src/unifi_scanner/reports/templates/report.txt"
      via: "env.get_template('report.txt')"
      pattern: "get_template.*report\\.txt"
---

<objective>
Create plain text report template with tiered detail levels per severity.

Purpose: Generate email-friendly plain text reports that serve as fallback when HTML cannot be rendered. Text reports use the tiered detail approach from CONTEXT.md: full detail for SEVERE, summary for MEDIUM, one-liner for LOW.

Output: Working generate_text() method in ReportGenerator using Jinja2 text template, with comprehensive tests.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-report-generation/04-RESEARCH.md
@.planning/phases/04-report-generation/04-CONTEXT.md
@.planning/phases/04-report-generation/04-01-SUMMARY.md
@src/unifi_scanner/reports/generator.py
@src/unifi_scanner/analysis/formatter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plain text report template</name>
  <files>src/unifi_scanner/reports/templates/report.txt</files>
  <action>
Create Jinja2 template for plain text report generation:

1. Header section:
   ```
   ============================================================
                       {{ report_title }}
   ============================================================
   Site: {{ site_name }}
   Period: {{ period_start_display }} to {{ period_end_display }}
   Generated: {{ generated_at_display }}
   ```

2. Executive Summary section:
   ```
   SUMMARY
   ----------------------------------------
   Total Findings: {{ counts.total }}
     SEVERE: {{ counts.severe }}
     MEDIUM: {{ counts.medium }}
     LOW:    {{ counts.low }}
   {% if counts.severe > 0 %}
   *** ACTION REQUIRED: {{ counts.severe }} severe issue(s) need attention ***
   {% endif %}
   ```

3. SEVERE section (full detail):
   - Only render if severe_findings is not empty
   - Section header with "SEVERE FINDINGS - Require Immediate Attention"
   - For each finding:
     - Title with category prefix
     - Device info
     - First seen / Last seen timestamps
     - Occurrence summary (includes [Recurring] if applicable)
     - Full description
     - Full remediation steps (if present)
   - Use FindingFormatter's format_finding() output

4. MEDIUM section (summary):
   - Only render if medium_findings is not empty
   - Section header with "MEDIUM FINDINGS - Should Be Addressed"
   - For each finding:
     - Title with category prefix
     - Device info
     - Occurrence summary
     - Brief description (first sentence or first 100 chars)
     - Remediation (if present)

5. LOW section (one-liner):
   - Only render if low_findings is not empty
   - Section header with "LOW FINDINGS - Informational"
   - For each finding:
     - Single line: "- {{ finding.title }} ({{ finding.occurrence_count }}x)"
   - No description, no remediation

6. Footer:
   ```
   ============================================================
   Generated by UniFi Scanner
   ============================================================
   ```

Use Jinja2 templating with:
- `{% if %}` for conditional sections
- `{% for %}` for finding loops
- `{{ }}` for variable interpolation
- `trim_blocks` and `lstrip_blocks` are already enabled in environment

Template should produce clean, readable output with consistent spacing.
  </action>
  <verify>
    - File exists at `src/unifi_scanner/reports/templates/report.txt`
    - Contains "SEVERE FINDINGS", "MEDIUM FINDINGS", "LOW FINDINGS" sections
    - Uses Jinja2 syntax ({% and {{)
  </verify>
  <done>Plain text template with tiered detail levels: full for SEVERE, summary for MEDIUM, one-liner for LOW</done>
</task>

<task type="auto">
  <name>Task 2: Implement generate_text() method</name>
  <files>src/unifi_scanner/reports/generator.py</files>
  <action>
Update ReportGenerator to implement generate_text():

1. Replace NotImplementedError stub with implementation:
   ```python
   def generate_text(self, report: Report) -> str:
       """Generate plain text report from Report model.

       Plain text reports use tiered detail levels:
       - SEVERE: Full detail (title, description, occurrence, remediation)
       - MEDIUM: Summary (title, brief description, occurrence, remediation)
       - LOW: One-liner (title and occurrence count only)

       Args:
           report: Report object containing findings to render

       Returns:
           Plain text report as string
       """
       template = self.env.get_template("report.txt")
       context = self._build_context(report)
       return template.render(**context)
   ```

2. Ensure autoescape does NOT apply to .txt files:
   - The existing `select_autoescape(["html", "xml"])` should already exclude .txt
   - Verify no HTML escaping happens in text output

3. No changes needed to _build_context() - it already provides all needed data:
   - report_title, site_name
   - period_start_display, period_end_display, generated_at_display
   - severe_findings, medium_findings, low_findings
   - counts dict

The implementation is intentionally simple - the template handles all formatting.
  </action>
  <verify>
    - `python -c "from unifi_scanner.reports import ReportGenerator; rg = ReportGenerator(); print(rg.generate_text.__doc__)"` shows docstring
    - `ruff check src/unifi_scanner/reports/generator.py` passes
  </verify>
  <done>generate_text() method implemented, uses report.txt template</done>
</task>

<task type="auto">
  <name>Task 3: Add comprehensive tests for text report generation</name>
  <files>tests/test_reports_text.py</files>
  <action>
Create test file with:

1. Fixtures (can reuse from test_reports_html.py or create new):
   - `severe_finding` - single SEVERE finding with remediation
   - `medium_finding` - single MEDIUM finding with remediation
   - `low_finding` - single LOW finding
   - `recurring_finding` - LOW finding with occurrence_count >= 5
   - `sample_report_mixed` - Report with 1 severe, 1 medium, 2 low findings
   - `sample_report_severe_only` - Report with only severe findings
   - `sample_report_low_only` - Report with only low findings

2. Test cases for basic structure:
   - `test_generate_text_returns_string` - returns str type
   - `test_generate_text_contains_title` - contains report_title
   - `test_generate_text_contains_site_name` - contains site_name
   - `test_generate_text_contains_period` - contains period timestamps
   - `test_generate_text_contains_summary` - contains "SUMMARY" and counts

3. Test cases for severity ordering:
   - `test_generate_text_severe_before_medium` - "SEVERE FINDINGS" appears before "MEDIUM FINDINGS"
   - `test_generate_text_medium_before_low` - "MEDIUM FINDINGS" appears before "LOW FINDINGS"

4. Test cases for tiered detail:
   - `test_generate_text_severe_full_detail` - severe finding includes title, description, remediation
   - `test_generate_text_medium_includes_remediation` - medium finding includes remediation
   - `test_generate_text_low_one_liner` - low finding is single line with title and count
   - `test_generate_text_low_no_description` - low finding does NOT include description
   - `test_generate_text_low_no_remediation` - low finding does NOT include remediation

5. Test cases for edge cases:
   - `test_generate_text_no_severe_section_when_empty` - no "SEVERE FINDINGS" when counts.severe == 0
   - `test_generate_text_no_medium_section_when_empty` - no "MEDIUM FINDINGS" when counts.medium == 0
   - `test_generate_text_no_low_section_when_empty` - no "LOW FINDINGS" when counts.low == 0
   - `test_generate_text_recurring_badge` - recurring finding shows [Recurring] in occurrence summary
   - `test_generate_text_action_required_when_severe` - shows "ACTION REQUIRED" when severe findings exist
   - `test_generate_text_no_html_escaping` - ampersand (&) in content is NOT escaped to &amp;

6. Test case for empty report:
   - `test_generate_text_empty_report` - report with no findings still generates valid output

Use string assertions to verify content presence/absence.
  </action>
  <verify>`pytest tests/test_reports_text.py -v` - all tests pass</verify>
  <done>Comprehensive test suite validates text report generation with 15+ tests</done>
</task>

</tasks>

<verification>
- Template file exists at `src/unifi_scanner/reports/templates/report.txt`
- `pytest tests/test_reports_text.py -v` all tests pass
- `python -c "from unifi_scanner.reports import ReportGenerator; from unifi_scanner.models.report import Report; from datetime import datetime; r = Report(period_start=datetime.now(), period_end=datetime.now(), site_name='Test', controller_type='udm_pro', findings=[]); rg = ReportGenerator(); print(rg.generate_text(r))"` - generates readable text
- Text output has no HTML escaping (& not converted to &amp;)
- SEVERE section shows full detail, LOW section shows one-liners only
</verification>

<success_criteria>
1. generate_text() returns plain text report
2. SEVERE findings appear first, then MEDIUM, then LOW
3. SEVERE findings show full detail (title, description, occurrence, remediation)
4. MEDIUM findings show summary with remediation
5. LOW findings show one-liner (title and count only)
6. Executive summary shows counts for each severity level
7. No HTML escaping in text output (plain text is not HTML)
8. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-report-generation/04-03-SUMMARY.md`
</output>

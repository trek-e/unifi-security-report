---
phase: 12-cybersecure-integration
plan: 02
type: tdd
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/unifi_scanner/analysis/ips/analyzer.py
  - tests/test_ips_analyzer.py
autonomous: true

must_haves:
  truths:
    - "ThreatSummary has is_cybersecure field set to True if ANY event is Cybersecure"
    - "ThreatSummary has cybersecure_count tracking how many events are Cybersecure"
    - "IPSAnalyzer propagates Cybersecure metadata when creating threat summaries"
  artifacts:
    - path: "src/unifi_scanner/analysis/ips/analyzer.py"
      provides: "ThreatSummary with Cybersecure fields, IPSAnalyzer propagation"
      contains: "is_cybersecure"
    - path: "tests/test_ips_analyzer.py"
      provides: "Tests for Cybersecure propagation"
      contains: "cybersecure"
  key_links:
    - from: "IPSEvent.is_cybersecure"
      to: "ThreatSummary.is_cybersecure"
      via: "_create_threat_summaries aggregation"
      pattern: "cybersecure_count"
---

<objective>
Extend ThreatSummary and IPSAnalyzer to propagate Cybersecure attribution

Purpose: Enable report templates to display Cybersecure badges by providing attribution metadata in ThreatSummary
Output: ThreatSummary dataclass with is_cybersecure and cybersecure_count fields, IPSAnalyzer propagating metadata
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-cybersecure-integration/12-RESEARCH.md

# Prior plan output
@.planning/phases/12-cybersecure-integration/12-01-SUMMARY.md

# Existing analyzer to extend
@src/unifi_scanner/analysis/ips/analyzer.py
@src/unifi_scanner/analysis/ips/models.py
@tests/test_ips_analyzer.py
</context>

<feature>
  <name>Cybersecure Attribution in ThreatSummary</name>
  <files>src/unifi_scanner/analysis/ips/analyzer.py, tests/test_ips_analyzer.py</files>
  <behavior>
    ThreatSummary should track Cybersecure attribution:
    - is_cybersecure: bool = False (True if ANY event in this summary has is_cybersecure=True)
    - cybersecure_count: int = 0 (count of events with is_cybersecure=True)

    IPSAnalyzer._create_threat_summaries should populate these fields:
    - Count events with is_cybersecure=True
    - Set is_cybersecure=True if cybersecure_count > 0

    Test cases:
    - All ET Open events (SID 2001xxx) -> is_cybersecure=False, cybersecure_count=0
    - All ET PRO events (SID 2800xxx) -> is_cybersecure=True, cybersecure_count=count
    - Mixed events (some ET PRO, some ET Open) -> is_cybersecure=True, cybersecure_count=<ET PRO count>
    - Single ET PRO event among many ET Open -> is_cybersecure=True, cybersecure_count=1
  </behavior>
  <implementation>
    1. Extend ThreatSummary dataclass with new fields (after remediation):
       is_cybersecure: bool = False
       cybersecure_count: int = 0

    2. Update _create_threat_summaries method:
       - After grouping events by signature, count Cybersecure events:
         cybersecure_events = [e for e in event_list if e.is_cybersecure]
         cybersecure_count = len(cybersecure_events)
       - Pass to ThreatSummary constructor:
         is_cybersecure=cybersecure_count > 0,
         cybersecure_count=cybersecure_count,

    Note: This relies on 12-01 having added is_cybersecure to IPSEvent
  </implementation>
</feature>

<verification>
```bash
# Run specific tests
pytest tests/test_ips_analyzer.py -v -k "cybersecure"

# Run all analyzer tests to ensure no regressions
pytest tests/test_ips_analyzer.py -v
```
</verification>

<success_criteria>
- [ ] ThreatSummary has is_cybersecure: bool = False field
- [ ] ThreatSummary has cybersecure_count: int = 0 field
- [ ] _create_threat_summaries counts Cybersecure events
- [ ] _create_threat_summaries sets is_cybersecure=True when count > 0
- [ ] Tests pass for all-standard, all-cybersecure, and mixed event scenarios
- [ ] All existing analyzer tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-cybersecure-integration/12-02-SUMMARY.md`
</output>

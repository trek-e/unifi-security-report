---
phase: 03-analysis-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/unifi_scanner/analysis/rules/security.py
  - src/unifi_scanner/analysis/rules/connectivity.py
  - src/unifi_scanner/analysis/rules/performance.py
  - src/unifi_scanner/analysis/rules/system.py
  - src/unifi_scanner/analysis/rules/__init__.py
  - tests/test_rules.py
autonomous: true

must_haves:
  truths:
    - "Rules exist for common security events (failed logins, intrusion alerts)"
    - "Rules exist for connectivity events (device disconnections, WAN outages)"
    - "Rules exist for performance events (high CPU, interference)"
    - "Rules exist for system events (firmware updates, reboots)"
    - "All rules have plain English descriptions with event type in parentheses"
    - "SEVERE and MEDIUM rules include remediation guidance"
  artifacts:
    - path: "src/unifi_scanner/analysis/rules/security.py"
      provides: "Security category rules"
      exports: ["SECURITY_RULES"]
    - path: "src/unifi_scanner/analysis/rules/connectivity.py"
      provides: "Connectivity category rules"
      exports: ["CONNECTIVITY_RULES"]
    - path: "src/unifi_scanner/analysis/rules/performance.py"
      provides: "Performance category rules"
      exports: ["PERFORMANCE_RULES"]
    - path: "src/unifi_scanner/analysis/rules/system.py"
      provides: "System category rules"
      exports: ["SYSTEM_RULES"]
  key_links:
    - from: "src/unifi_scanner/analysis/rules/__init__.py"
      to: "src/unifi_scanner/analysis/rules/*.py"
      via: "Imports and aggregates all rule lists"
      pattern: "ALL_RULES"
    - from: "tests/test_rules.py"
      to: "src/unifi_scanner/analysis/rules/__init__.py"
      via: "Tests rule definitions and templates"
      pattern: "from unifi_scanner.analysis.rules"
---

<objective>
Create the initial rule set for common UniFi event types across all four categories.

Purpose: These rules define how specific UniFi events map to findings with appropriate severity, plain English explanations, and remediation guidance. Each rule follows user decisions: SEVERE/MEDIUM get remediation, explanations include event type in parentheses for Googling, categories are shown in titles.

Output: Rule definitions for security, connectivity, performance, and system categories with comprehensive tests.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-analysis-engine/03-CONTEXT.md
@.planning/phases/03-analysis-engine/03-RESEARCH.md

# From Plan 03-01
@src/unifi_scanner/analysis/rules/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security category rules</name>
  <files>src/unifi_scanner/analysis/rules/security.py</files>
  <action>
Create security rules for authentication and intrusion events:

```python
"""Security category rules for UniFi analysis.

Handles: Failed logins, intrusion alerts, rogue AP detection, unauthorized access.
Per user decision: SEVERE = requires admin action within 24 hours.
"""

from unifi_scanner.analysis.rules.base import Rule
from unifi_scanner.models.enums import Category, Severity


SECURITY_RULES = [
    Rule(
        name="admin_login_failed",
        event_types=["EVT_AD_LOGIN_FAILED", "EVT_AD_LoginFailed"],
        category=Category.SECURITY,
        severity=Severity.SEVERE,
        title_template="[Security] Failed login attempt from {ip}",
        description_template=(
            "Someone attempted to log into your UniFi controller from {ip} but "
            "failed authentication (EVT_AD_LOGIN_FAILED). This could indicate "
            "someone trying to guess your password. If this happens repeatedly, "
            "your controller may be under a brute-force attack."
        ),
        remediation_template=(
            "1. Check if you recognize the IP address {ip}\n"
            "2. If unfamiliar, consider blocking it in your firewall\n"
            "3. Ensure your admin password is strong and unique\n"
            "4. Enable two-factor authentication if available in your UniFi setup\n"
            "5. Review Settings > System > Admin in your UniFi controller"
        ),
    ),

    Rule(
        name="rogue_ap_detected",
        event_types=["EVT_AP_DetectRogueAP"],
        category=Category.SECURITY,
        severity=Severity.SEVERE,
        title_template="[Security] Rogue access point detected near {device_name}",
        description_template=(
            "Your access point {device_name} detected an unauthorized wireless network "
            "nearby (EVT_AP_DetectRogueAP). This could be a neighbor's network, but "
            "could also indicate someone attempting to set up a malicious hotspot "
            "to intercept your traffic."
        ),
        remediation_template=(
            "1. Open the UniFi app and go to Insights > WiFi\n"
            "2. Look for unknown SSIDs broadcasting near your network\n"
            "3. If the SSID looks suspicious (similar to yours), investigate further\n"
            "4. Consider enabling SSID hiding if you don't need discovery\n"
            "5. Check if any unauthorized devices were connected to your network"
        ),
    ),

    Rule(
        name="ips_alert",
        event_types=["EVT_IPS_Alert", "EVT_IPS_IpsAlert"],
        category=Category.SECURITY,
        severity=Severity.SEVERE,
        title_template="[Security] Intrusion detection alert",
        description_template=(
            "Your UniFi threat management system detected suspicious network activity "
            "(EVT_IPS_Alert). The intrusion prevention system flagged traffic that "
            "matches known attack patterns. This could indicate malware on your "
            "network or an external attack attempt."
        ),
        remediation_template=(
            "1. Open UniFi and go to Insights > Threat Management\n"
            "2. Review the specific alert details and source/destination IPs\n"
            "3. If the source is an internal device, scan it for malware\n"
            "4. If the source is external, the traffic was likely blocked\n"
            "5. Consider temporarily isolating affected devices if threat is active"
        ),
    ),

    Rule(
        name="admin_login_success",
        event_types=["EVT_AD_Login", "EVT_AD_LoginSuccess"],
        category=Category.SECURITY,
        severity=Severity.LOW,
        title_template="[Security] Admin login from {ip}",
        description_template=(
            "An administrator logged into your UniFi controller from {ip} "
            "(EVT_AD_Login). This is normal if you or a known admin initiated it. "
            "This is logged for your awareness."
        ),
        remediation_template=None,  # LOW severity, no remediation needed
    ),
]
```

Note: Event type variations (EVT_AD_LoginFailed vs EVT_AD_LOGIN_FAILED) exist across firmware versions, so rules should handle both forms when known.
  </action>
  <verify>
Run: `python -c "from unifi_scanner.analysis.rules.security import SECURITY_RULES; print(f'{len(SECURITY_RULES)} security rules'); print([r.name for r in SECURITY_RULES])"`
Should print: `4 security rules` followed by rule names
  </verify>
  <done>
Security rules cover failed logins (SEVERE), rogue AP detection (SEVERE), IPS alerts (SEVERE), and successful logins (LOW for awareness).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create connectivity and performance category rules</name>
  <files>
src/unifi_scanner/analysis/rules/connectivity.py
src/unifi_scanner/analysis/rules/performance.py
  </files>
  <action>
1. Create `src/unifi_scanner/analysis/rules/connectivity.py`:

```python
"""Connectivity category rules for UniFi analysis.

Handles: Device disconnections, WAN outages, client connection issues.
Per user decision: Lost contact with devices = SEVERE (requires action).
"""

from unifi_scanner.analysis.rules.base import Rule
from unifi_scanner.models.enums import Category, Severity


CONNECTIVITY_RULES = [
    Rule(
        name="ap_lost_contact",
        event_types=["EVT_AP_Lost_Contact", "EVT_AP_Disconnected"],
        category=Category.CONNECTIVITY,
        severity=Severity.SEVERE,
        title_template="[Connectivity] Lost contact with {device_name}",
        description_template=(
            "Your access point {device_name} ({device_mac}) stopped responding "
            "to the controller (EVT_AP_Lost_Contact). Devices connected to this "
            "AP have lost WiFi connectivity in that area. This could be due to "
            "power loss, network cable issues, or hardware failure."
        ),
        remediation_template=(
            "1. Check if the access point has power (LED should be lit)\n"
            "2. Verify the ethernet cable is connected at both ends\n"
            "3. Try power cycling the AP by unplugging for 10 seconds\n"
            "4. Check your switch port for errors or PoE budget issues\n"
            "5. If using PoE, ensure your switch can provide enough power"
        ),
    ),

    Rule(
        name="switch_lost_contact",
        event_types=["EVT_SW_Lost_Contact", "EVT_SW_Disconnected"],
        category=Category.CONNECTIVITY,
        severity=Severity.SEVERE,
        title_template="[Connectivity] Lost contact with switch {device_name}",
        description_template=(
            "Your network switch {device_name} ({device_mac}) stopped responding "
            "to the controller (EVT_SW_Lost_Contact). All devices connected to "
            "this switch have lost network connectivity. This affects any APs, "
            "computers, or other equipment plugged into this switch."
        ),
        remediation_template=(
            "1. Check if the switch has power (LEDs should be lit)\n"
            "2. Verify the uplink cable to your router/gateway is secure\n"
            "3. Try power cycling the switch by unplugging for 10 seconds\n"
            "4. Check if other devices on the same circuit lost power\n"
            "5. If the switch is warm/hot, let it cool before restarting"
        ),
    ),

    Rule(
        name="gateway_wan_down",
        event_types=["EVT_GW_WANTransition", "EVT_GW_WAN_Down"],
        category=Category.CONNECTIVITY,
        severity=Severity.SEVERE,
        title_template="[Connectivity] Internet connection lost",
        description_template=(
            "Your gateway's WAN interface went down (EVT_GW_WANTransition). "
            "This means your entire network has lost internet connectivity. "
            "All devices can still communicate locally but cannot reach the "
            "internet. This could be an ISP outage or modem issue."
        ),
        remediation_template=(
            "1. Check if your modem/ONT has power and shows online status\n"
            "2. Try power cycling your modem (unplug 30 seconds, replug)\n"
            "3. Check your ISP's status page for reported outages\n"
            "4. Verify the cable between modem and UniFi gateway is secure\n"
            "5. If using PPPoE, verify your ISP credentials haven't changed"
        ),
    ),

    Rule(
        name="ap_isolated",
        event_types=["EVT_AP_Isolated"],
        category=Category.CONNECTIVITY,
        severity=Severity.SEVERE,
        title_template="[Connectivity] Access point {device_name} isolated from network",
        description_template=(
            "Your access point {device_name} has been isolated from the network "
            "(EVT_AP_Isolated). The AP can't reach the controller and may have "
            "limited functionality. Wireless clients may experience intermittent "
            "connectivity issues."
        ),
        remediation_template=(
            "1. Check the ethernet cable connecting the AP to your switch\n"
            "2. Verify the switch port isn't disabled or in an error state\n"
            "3. Check for VLAN misconfigurations if using VLANs\n"
            "4. Try moving the AP to a different switch port\n"
            "5. Power cycle the AP if cable and port look good"
        ),
    ),

    Rule(
        name="ap_connected",
        event_types=["EVT_AP_Connected", "EVT_AP_Adopted"],
        category=Category.CONNECTIVITY,
        severity=Severity.LOW,
        title_template="[Connectivity] Access point {device_name} connected",
        description_template=(
            "Your access point {device_name} connected to the controller "
            "(EVT_AP_Connected). This is normal when an AP comes back online "
            "after a restart or when a new AP is adopted into your network."
        ),
        remediation_template=None,
    ),

    Rule(
        name="client_connected",
        event_types=["EVT_WU_Connected", "EVT_LU_Connected"],
        category=Category.CONNECTIVITY,
        severity=Severity.LOW,
        title_template="[Connectivity] Client device connected",
        description_template=(
            "A device connected to your network (EVT_WU_Connected). This is "
            "normal activity as devices join and rejoin your WiFi network "
            "throughout the day."
        ),
        remediation_template=None,
    ),

    Rule(
        name="client_disconnected",
        event_types=["EVT_WU_Disconnected", "EVT_LU_Disconnected"],
        category=Category.CONNECTIVITY,
        severity=Severity.LOW,
        title_template="[Connectivity] Client device disconnected",
        description_template=(
            "A device disconnected from your network (EVT_WU_Disconnected). "
            "This is normal activity as devices move out of range, go to sleep, "
            "or switch between access points."
        ),
        remediation_template=None,
    ),
]
```

2. Create `src/unifi_scanner/analysis/rules/performance.py`:

```python
"""Performance category rules for UniFi analysis.

Handles: High CPU, memory pressure, wireless interference, slow responses.
Per user decision: Performance = MEDIUM (worth monitoring but not urgent).
"""

from unifi_scanner.analysis.rules.base import Rule
from unifi_scanner.models.enums import Category, Severity


PERFORMANCE_RULES = [
    Rule(
        name="ap_interference",
        event_types=["EVT_AP_PossibleInterference"],
        category=Category.PERFORMANCE,
        severity=Severity.MEDIUM,
        title_template="[Performance] Wireless interference detected on {device_name}",
        description_template=(
            "Your access point {device_name} detected possible wireless "
            "interference (EVT_AP_PossibleInterference). This can cause slower "
            "WiFi speeds and connection drops. Common sources include neighboring "
            "WiFi networks, Bluetooth devices, microwaves, and cordless phones."
        ),
        remediation_template=(
            "1. Try changing the WiFi channel in Settings > WiFi > Advanced\n"
            "2. Enable automatic channel selection if not already on\n"
            "3. Move the AP away from known interference sources\n"
            "4. Consider using 5GHz band for less interference"
        ),
    ),

    Rule(
        name="high_cpu_usage",
        event_types=["EVT_AP_HighCPU", "EVT_SW_HighCPU", "EVT_GW_HighCPU"],
        category=Category.PERFORMANCE,
        severity=Severity.MEDIUM,
        title_template="[Performance] High CPU usage on {device_name}",
        description_template=(
            "Your device {device_name} is experiencing high CPU usage "
            "(EVT_AP_HighCPU). This can cause slower network performance "
            "and delayed responses. Sustained high CPU may indicate the device "
            "is overloaded or experiencing issues."
        ),
        remediation_template=(
            "1. Check how many clients are connected to this device\n"
            "2. Look for any bandwidth-heavy applications running\n"
            "3. Try restarting the device if issue persists\n"
            "4. Check if firmware is up to date"
        ),
    ),

    Rule(
        name="high_memory_usage",
        event_types=["EVT_AP_HighMemory", "EVT_SW_HighMemory", "EVT_GW_HighMemory"],
        category=Category.PERFORMANCE,
        severity=Severity.MEDIUM,
        title_template="[Performance] High memory usage on {device_name}",
        description_template=(
            "Your device {device_name} is running low on memory "
            "(EVT_AP_HighMemory). This can cause instability and potential "
            "crashes. Memory usually fills up over time and a restart often "
            "resolves the issue."
        ),
        remediation_template=(
            "1. Try restarting the device to clear memory\n"
            "2. Check if firmware is up to date (updates often fix memory leaks)\n"
            "3. If recurring, consider reducing connected clients or features"
        ),
    ),

    Rule(
        name="speed_test_slow",
        event_types=["EVT_GW_SpeedTestSlow"],
        category=Category.PERFORMANCE,
        severity=Severity.MEDIUM,
        title_template="[Performance] Speed test shows slow internet",
        description_template=(
            "A speed test from your gateway showed slower than expected internet "
            "speeds (EVT_GW_SpeedTestSlow). This could indicate ISP throttling, "
            "network congestion, or connection issues between your gateway and modem."
        ),
        remediation_template=(
            "1. Run a speed test from your ISP's website to compare\n"
            "2. Try power cycling your modem and gateway\n"
            "3. Check for other devices using heavy bandwidth\n"
            "4. Contact your ISP if speeds are consistently below plan"
        ),
    ),

    Rule(
        name="channel_utilization_high",
        event_types=["EVT_AP_ChannelUtilHigh"],
        category=Category.PERFORMANCE,
        severity=Severity.MEDIUM,
        title_template="[Performance] High channel utilization on {device_name}",
        description_template=(
            "The wireless channel used by {device_name} is congested "
            "(EVT_AP_ChannelUtilHigh). This means many devices or neighboring "
            "networks are competing for airtime, which slows down your WiFi."
        ),
        remediation_template=(
            "1. Enable automatic channel selection in WiFi settings\n"
            "2. Consider switching to 5GHz or 6GHz if devices support it\n"
            "3. Reduce the number of SSIDs if you have many configured\n"
            "4. Stagger channel widths across APs"
        ),
    ),
]
```
  </action>
  <verify>
Run: `python -c "from unifi_scanner.analysis.rules.connectivity import CONNECTIVITY_RULES; from unifi_scanner.analysis.rules.performance import PERFORMANCE_RULES; print(f'{len(CONNECTIVITY_RULES)} connectivity, {len(PERFORMANCE_RULES)} performance rules')"`
Should print: `7 connectivity, 5 performance rules`
  </verify>
  <done>
Connectivity rules cover device disconnections (SEVERE), WAN outages (SEVERE), and normal client events (LOW). Performance rules cover interference, high CPU/memory, and speed issues (all MEDIUM).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create system category rules, aggregate exports, and tests</name>
  <files>
src/unifi_scanner/analysis/rules/system.py
src/unifi_scanner/analysis/rules/__init__.py
tests/test_rules.py
  </files>
  <action>
1. Create `src/unifi_scanner/analysis/rules/system.py`:

```python
"""System category rules for UniFi analysis.

Handles: Firmware updates, reboots, configuration changes, device adoption.
Per user decision: Routine operations = LOW, unexpected events = MEDIUM.
"""

from unifi_scanner.analysis.rules.base import Rule
from unifi_scanner.models.enums import Category, Severity


SYSTEM_RULES = [
    Rule(
        name="firmware_upgraded",
        event_types=["EVT_AP_Upgraded", "EVT_SW_Upgraded", "EVT_GW_Upgraded"],
        category=Category.SYSTEM,
        severity=Severity.LOW,
        title_template="[System] {device_name} firmware updated",
        description_template=(
            "Your device {device_name} completed a firmware upgrade "
            "(EVT_AP_Upgraded). The device may have restarted as part of the "
            "update process. This is normal maintenance activity."
        ),
        remediation_template=None,
    ),

    Rule(
        name="device_restarted",
        event_types=["EVT_AP_Restarted", "EVT_SW_Restarted", "EVT_GW_Restarted"],
        category=Category.SYSTEM,
        severity=Severity.LOW,
        title_template="[System] {device_name} restarted",
        description_template=(
            "Your device {device_name} was restarted (EVT_AP_Restarted). "
            "If you initiated this restart, no action is needed. The device "
            "is now back online and functioning normally."
        ),
        remediation_template=None,
    ),

    Rule(
        name="device_restarted_unknown",
        event_types=[
            "EVT_AP_RestartedUnknown",
            "EVT_SW_RestartedUnknown",
            "EVT_GW_RestartedUnknown",
        ],
        category=Category.SYSTEM,
        severity=Severity.MEDIUM,
        title_template="[System] {device_name} restarted unexpectedly",
        description_template=(
            "Your device {device_name} restarted for an unknown reason "
            "(EVT_AP_RestartedUnknown). This could indicate a power fluctuation, "
            "firmware crash, or hardware issue. Occasional unexpected restarts "
            "may be normal, but frequent occurrences warrant investigation."
        ),
        remediation_template=(
            "1. Check if there were any power outages in your area\n"
            "2. Verify the power source is stable (try different outlet/PoE port)\n"
            "3. Check if firmware is up to date\n"
            "4. Monitor for repeated occurrences over the next few days"
        ),
    ),

    Rule(
        name="device_adopted",
        event_types=["EVT_AP_Adopted", "EVT_SW_Adopted", "EVT_GW_Adopted"],
        category=Category.SYSTEM,
        severity=Severity.LOW,
        title_template="[System] New device {device_name} adopted",
        description_template=(
            "A new device {device_name} was adopted into your UniFi network "
            "(EVT_AP_Adopted). The device is now managed by your controller "
            "and can be configured through the UniFi interface."
        ),
        remediation_template=None,
    ),

    Rule(
        name="config_changed",
        event_types=["EVT_AD_ConfigChange", "EVT_ConfigChanged"],
        category=Category.SYSTEM,
        severity=Severity.LOW,
        title_template="[System] Configuration changed by {user}",
        description_template=(
            "Network configuration was changed by {user} (EVT_AD_ConfigChange). "
            "This is logged for your records. Review if you did not make this "
            "change yourself."
        ),
        remediation_template=None,
    ),

    Rule(
        name="backup_created",
        event_types=["EVT_AD_BackupCreated", "EVT_BackupComplete"],
        category=Category.SYSTEM,
        severity=Severity.LOW,
        title_template="[System] Backup created successfully",
        description_template=(
            "A backup of your UniFi configuration was created "
            "(EVT_AD_BackupCreated). Your settings are now saved and can be "
            "restored if needed."
        ),
        remediation_template=None,
    ),

    Rule(
        name="update_available",
        event_types=["EVT_AP_UpdateAvailable", "EVT_SW_UpdateAvailable"],
        category=Category.SYSTEM,
        severity=Severity.LOW,
        title_template="[System] Firmware update available for {device_name}",
        description_template=(
            "A firmware update is available for {device_name} "
            "(EVT_AP_UpdateAvailable). Keeping firmware up to date improves "
            "security and stability. Updates can be applied from the UniFi app."
        ),
        remediation_template=None,
    ),
]
```

2. Update `src/unifi_scanner/analysis/rules/__init__.py`:

```python
"""Analysis rules for UniFi event processing.

Provides rule definitions for all categories: Security, Connectivity,
Performance, and System. Use ALL_RULES to get all rules for registration
with AnalysisEngine.
"""

from unifi_scanner.analysis.rules.base import Rule, RuleRegistry
from unifi_scanner.analysis.rules.security import SECURITY_RULES
from unifi_scanner.analysis.rules.connectivity import CONNECTIVITY_RULES
from unifi_scanner.analysis.rules.performance import PERFORMANCE_RULES
from unifi_scanner.analysis.rules.system import SYSTEM_RULES


# Aggregate all rules for easy registration
ALL_RULES = SECURITY_RULES + CONNECTIVITY_RULES + PERFORMANCE_RULES + SYSTEM_RULES


def get_default_registry() -> RuleRegistry:
    """Create a RuleRegistry with all default rules registered.

    Returns:
        RuleRegistry with all built-in rules
    """
    registry = RuleRegistry()
    for rule in ALL_RULES:
        registry.register(rule)
    return registry


__all__ = [
    "Rule",
    "RuleRegistry",
    "SECURITY_RULES",
    "CONNECTIVITY_RULES",
    "PERFORMANCE_RULES",
    "SYSTEM_RULES",
    "ALL_RULES",
    "get_default_registry",
]
```

3. Create `tests/test_rules.py`:

```python
"""Tests for analysis rules."""

import pytest
from datetime import datetime, timezone

from unifi_scanner.analysis.rules import (
    Rule,
    RuleRegistry,
    ALL_RULES,
    SECURITY_RULES,
    CONNECTIVITY_RULES,
    PERFORMANCE_RULES,
    SYSTEM_RULES,
    get_default_registry,
)
from unifi_scanner.analysis import AnalysisEngine
from unifi_scanner.models.enums import Category, Severity, LogSource
from unifi_scanner.models.log_entry import LogEntry


class TestRuleCoverage:
    """Test that rules are properly defined."""

    def test_all_rules_aggregated(self):
        """Test that ALL_RULES contains rules from all categories."""
        expected_count = (
            len(SECURITY_RULES)
            + len(CONNECTIVITY_RULES)
            + len(PERFORMANCE_RULES)
            + len(SYSTEM_RULES)
        )
        assert len(ALL_RULES) == expected_count
        assert len(ALL_RULES) >= 20  # Sanity check for minimum rules

    def test_all_rules_have_required_fields(self):
        """Test that all rules have required fields populated."""
        for rule in ALL_RULES:
            assert rule.name, f"Rule missing name"
            assert rule.event_types, f"Rule {rule.name} missing event_types"
            assert rule.category, f"Rule {rule.name} missing category"
            assert rule.severity, f"Rule {rule.name} missing severity"
            assert rule.title_template, f"Rule {rule.name} missing title_template"
            assert rule.description_template, f"Rule {rule.name} missing description_template"

    def test_severe_rules_have_remediation(self):
        """Test that SEVERE rules include remediation guidance."""
        for rule in ALL_RULES:
            if rule.severity == Severity.SEVERE:
                assert rule.remediation_template is not None, (
                    f"SEVERE rule {rule.name} missing remediation"
                )

    def test_medium_rules_have_remediation(self):
        """Test that MEDIUM rules include remediation guidance."""
        for rule in ALL_RULES:
            if rule.severity == Severity.MEDIUM:
                assert rule.remediation_template is not None, (
                    f"MEDIUM rule {rule.name} missing remediation"
                )

    def test_low_rules_no_remediation(self):
        """Test that LOW rules do not include remediation (per user decision)."""
        for rule in ALL_RULES:
            if rule.severity == Severity.LOW:
                assert rule.remediation_template is None, (
                    f"LOW rule {rule.name} should not have remediation"
                )

    def test_titles_include_category(self):
        """Test that rule titles include category prefix per user decision."""
        for rule in ALL_RULES:
            category_prefix = f"[{rule.category.value.title()}]"
            assert category_prefix in rule.title_template, (
                f"Rule {rule.name} title should start with {category_prefix}"
            )

    def test_descriptions_include_event_type(self):
        """Test that descriptions include event type for Googling."""
        for rule in ALL_RULES:
            # Check that at least one event type appears in description
            has_event_type = any(
                evt in rule.description_template for evt in rule.event_types
            )
            assert has_event_type, (
                f"Rule {rule.name} description should include event type for searchability"
            )


class TestSecurityRules:
    """Test security category rules."""

    def test_failed_login_rule_matches(self):
        """Test failed login rule triggers on correct event."""
        registry = get_default_registry()
        rule = registry.find_matching_rule("EVT_AD_LOGIN_FAILED", "Login failed")

        assert rule is not None
        assert rule.category == Category.SECURITY
        assert rule.severity == Severity.SEVERE

    def test_rogue_ap_rule_matches(self):
        """Test rogue AP detection rule."""
        registry = get_default_registry()
        rule = registry.find_matching_rule("EVT_AP_DetectRogueAP", "Rogue AP")

        assert rule is not None
        assert rule.severity == Severity.SEVERE


class TestConnectivityRules:
    """Test connectivity category rules."""

    def test_ap_lost_contact_rule(self):
        """Test AP lost contact is SEVERE."""
        registry = get_default_registry()
        rule = registry.find_matching_rule("EVT_AP_Lost_Contact", "Lost contact")

        assert rule is not None
        assert rule.severity == Severity.SEVERE
        assert rule.category == Category.CONNECTIVITY

    def test_client_disconnect_is_low(self):
        """Test client disconnect is LOW severity (normal operation)."""
        registry = get_default_registry()
        rule = registry.find_matching_rule("EVT_WU_Disconnected", "Client left")

        assert rule is not None
        assert rule.severity == Severity.LOW


class TestPerformanceRules:
    """Test performance category rules."""

    def test_interference_rule(self):
        """Test interference is MEDIUM severity."""
        registry = get_default_registry()
        rule = registry.find_matching_rule("EVT_AP_PossibleInterference", "Interference")

        assert rule is not None
        assert rule.severity == Severity.MEDIUM
        assert rule.category == Category.PERFORMANCE


class TestSystemRules:
    """Test system category rules."""

    def test_firmware_upgrade_is_low(self):
        """Test firmware upgrade is LOW (routine operation)."""
        registry = get_default_registry()
        rule = registry.find_matching_rule("EVT_AP_Upgraded", "Upgraded")

        assert rule is not None
        assert rule.severity == Severity.LOW

    def test_unexpected_restart_is_medium(self):
        """Test unexpected restart is MEDIUM (warrants monitoring)."""
        registry = get_default_registry()
        rule = registry.find_matching_rule("EVT_AP_RestartedUnknown", "Restarted")

        assert rule is not None
        assert rule.severity == Severity.MEDIUM


class TestEngineWithRules:
    """Test AnalysisEngine with full rule set."""

    @pytest.fixture
    def engine(self):
        """Create engine with all rules."""
        engine = AnalysisEngine()
        engine.register_rules(ALL_RULES)
        return engine

    def test_analyze_security_event(self, engine):
        """Test analyzing a security event produces correct finding."""
        entry = LogEntry(
            timestamp=datetime.now(timezone.utc),
            source=LogSource.API,
            event_type="EVT_AD_LOGIN_FAILED",
            message="Login failed",
            raw_data={"ip": "192.168.1.50"},
        )

        finding = engine.analyze_entry(entry)

        assert finding is not None
        assert finding.category == Category.SECURITY
        assert "192.168.1.50" in finding.title
        assert "192.168.1.50" in finding.remediation

    def test_analyze_unknown_event(self, engine):
        """Test unknown events are tracked but don't produce findings."""
        entry = LogEntry(
            timestamp=datetime.now(timezone.utc),
            source=LogSource.API,
            event_type="EVT_FUTURE_NEW_EVENT",
            message="Something new",
        )

        finding = engine.analyze_entry(entry)

        assert finding is None
        assert "EVT_FUTURE_NEW_EVENT" in engine.unknown_event_types

    def test_all_known_event_types_registered(self, engine):
        """Test all rule event types are registered."""
        for rule in ALL_RULES:
            for event_type in rule.event_types:
                assert engine.registry.is_known_event_type(event_type), (
                    f"Event type {event_type} from rule {rule.name} not registered"
                )
```
  </action>
  <verify>
Run: `pytest tests/test_rules.py -v`
All tests should pass.
  </verify>
  <done>
System rules cover firmware updates (LOW), restarts (LOW/MEDIUM), device adoption (LOW), and config changes (LOW). All rules aggregated in ALL_RULES with get_default_registry() helper. Comprehensive tests validate rule structure and integration.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from unifi_scanner.analysis.rules import ALL_RULES; print(f'{len(ALL_RULES)} total rules')"`
2. `python -c "from unifi_scanner.analysis.rules import get_default_registry; r = get_default_registry(); print(f'{len(r.known_event_types)} event types covered')"`
3. `pytest tests/test_rules.py -v` - all tests pass
4. Verify rule quality:
   ```python
   from unifi_scanner.analysis.rules import ALL_RULES
   from unifi_scanner.models.enums import Severity
   severe = [r for r in ALL_RULES if r.severity == Severity.SEVERE]
   for r in severe:
       assert r.remediation_template, f"{r.name} missing remediation"
   print(f"{len(severe)} SEVERE rules all have remediation")
   ```
</verification>

<success_criteria>
- SECURITY_RULES covers failed logins, rogue AP, IPS alerts (SEVERE) and successful logins (LOW)
- CONNECTIVITY_RULES covers device disconnections (SEVERE), WAN outages (SEVERE), client events (LOW)
- PERFORMANCE_RULES covers interference, CPU, memory, speed issues (all MEDIUM)
- SYSTEM_RULES covers updates, restarts (LOW), unexpected restarts (MEDIUM), adoption (LOW)
- ALL_RULES aggregates 20+ rules from all categories
- get_default_registry() returns fully populated RuleRegistry
- All SEVERE and MEDIUM rules have remediation_template
- All LOW rules have remediation_template=None
- All titles include category prefix [Security], [Connectivity], etc.
- All descriptions include at least one event_type for searchability
- Tests verify rule structure and integration with AnalysisEngine
</success_criteria>

<output>
After completion, create `.planning/phases/03-analysis-engine/03-02-SUMMARY.md`
</output>

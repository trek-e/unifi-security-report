# Milestone v0.3-alpha: No Duplicate Reports

**Status:** SHIPPED 2026-01-24
**Phases:** 6
**Total Plans:** 2

## Overview

v0.3-alpha adds state persistence to prevent duplicate event reporting across runs. The service now tracks when the last successful report was delivered and only processes events that occurred after that timestamp.

## Phases

### Phase 6: State Persistence

**Goal**: Service tracks last successful report and only processes new events to prevent duplicate reporting
**Depends on**: Phase 5
**Requirements**: STATE-01, STATE-02, STATE-03, STATE-04, STATE-05, STATE-06, STATE-07, CONF-01, CONF-02
**Success Criteria** (what must be TRUE):
  1. Service remembers when the last successful report was delivered and uses it as the timestamp cutoff for the next run
  2. User sees no duplicate events across multiple scheduled runs (same event never appears in two reports)
  3. First-time service startup processes events from the last 24 hours (or configurable initial lookback)
  4. If state file is corrupted or missing, service logs a warning and falls back to default lookback (no crash)
**Plans**: 2 plans

Plans:
- [x] 06-01-PLAN.md — StateManager module with atomic writes and configuration
- [x] 06-02-PLAN.md — Log collector integration and pipeline state lifecycle

---

## Milestone Summary

**Key Decisions:**
- Atomic write via tempfile.mkstemp + shutil.move (same pattern as FileDelivery)
- State file .last_run.json in reports directory
- Schema version 1.0 in state file for future migration support
- Timezone-naive timestamps rejected (must be UTC-aware)
- Corrupted/invalid state returns None with warning (graceful degradation)
- Client-side timestamp filtering (UniFi API lacks timestamp filter support)
- 5-minute clock skew tolerance for time drift between scanner and controller
- Empty reports still delivered (user confirmation + state update prevents repeats)

**Issues Resolved:**
- Issue #1: Don't Send Previous Logs — events now filtered by last successful run timestamp

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- 2 pre-existing test failures in test_models.py (timezone-aware vs naive datetime assertions)
- Pydantic deprecation warning for json_encoders (future migration needed)

---

_For current project status, see .planning/ROADMAP.md_

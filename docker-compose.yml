# UniFi Security Report - Docker Compose Configuration
# v0.5.5b - Includes MongoDB IPS collection via SSH

services:
  unifi-security-report:
    image: ghcr.io/trek-e/unifi-security-report:latest
    container_name: unifi-security-report
    restart: unless-stopped
    network_mode: host

    environment:
      # Connection
      UNIFI_HOST: 192.168.0.1
      UNIFI_USERNAME: admin
      UNIFI_VERIFY_SSL: "false"

      # Schedule (runs daily at 8am Eastern)
      UNIFI_SCHEDULE_PRESET: daily_8am
      UNIFI_SCHEDULE_TIMEZONE: America/New_York

      # File Output
      UNIFI_FILE_ENABLED: "true"
      UNIFI_FILE_OUTPUT_DIR: /app/reports
      UNIFI_FILE_FORMAT: both
      UNIFI_FILE_RETENTION_DAYS: "30"

      # SSH for IPS via MongoDB (v0.5.5b+)
      # UniFi API doesn't expose IPS events, so we query MongoDB directly via SSH
      # Requires SSH key authentication (password auth is disabled on UDM Pro)
      UNIFI_SSH_ENABLED: "true"
      UNIFI_SSH_KEY_PATH: /run/secrets/ssh_key
      UNIFI_SSH_USERNAME: root
      # UNIFI_SSH_KEY_PASSPHRASE: ""  # Uncomment if key is encrypted

      # Logging
      UNIFI_LOG_LEVEL: INFO
      UNIFI_LOG_FORMAT: json

    secrets:
      - unifi_password
      - ssh_key

    volumes:
      - ./reports:/app/reports:rw

secrets:
  unifi_password:
    file: ./secrets/unifi_password.txt
  ssh_key:
    file: ./secrets/unifi_ssh_key
    # Generate with: ssh-keygen -t ed25519 -f ./secrets/unifi_ssh_key
    # Copy public key to UDM: cat ./secrets/unifi_ssh_key.pub | ssh root@192.168.0.1 "cat >> ~/.ssh/authorized_keys"
